#!/usr/bin/make -f

DEB_PYTHON_SYSTEM=pysupport
DEB_DH_INSTALL_SOURCEDIR = debian/tmp

MIRROR=http://apt:9999/debian
REPO=sid

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/cdbs/1/class/python-distutils.mk

DEBIAN_SKIP_TEST := \
	SKIP_TEST_HEXDUMP_0 \
	SKIP_TEST_HEXDUMP_1 \
	SKIP_TEST_VGS_1


DEB_CONFIGURE_EXTRA_FLAGS := \
	--with-readline		\
	--with-repo=${REPO}     \
        --with-mirror=${MIRROR}

DEB_DBG_PACKAGES = libguestfs0-dbg
DEB_PYTHON_SETUP_CMD := /dev/null
DEB_DH_MAKESHLIBS_ARGS_python-guestfs = -X usr/lib/pyshared

# make sure the debirf symlinks get created:
configure/guestfish::
	cd appliance; make stamp-debirf-modules

ifeq (,$(findstring nocheck,$(DEB_BUILD_OPTIONS)))
debian/check-stamp:
	for TEST in ${DEBIAN_SKIP_TEST}; do \
	    export $$TEST=1; \
	done; \
	make check
	touch debian/check-stamp

build/guestfish:: debian/check-stamp
endif

install/python-guestfs::
	rm -f debian/tmp/usr/lib/python*/*/libguestfsmod.so
	for mod in debian/tmp/usr/lib/python*/*/libguestfsmod.so.0.0.0; do \
		mv $${mod} $$(dirname $${mod})/libguestfsmod.so; \
	done

clean::
	rm -rf appliance/debian/root \
	       appliance/debian/nest \
	       appliance/debian/vmlinuz-* \
	       appliance/debian/*.cgz \
	       appliance/*.bak
	rm -rf perl/blib/ perl/*.o
	rm -f src/.pod2text.data po/*.gmo
	rm -f debian/check-stamp
