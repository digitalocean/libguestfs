From: Hilko Bengen <bengen@debian.org>
Date: Sat, 20 Aug 2011 10:34:46 +0200
Subject: Do not run appliance-related checks if not building appliance

---
 Makefile.am        |    5 ++++-
 cat/Makefile.am    |    2 ++
 df/Makefile.am     |    2 ++
 edit/Makefile.am   |    2 ++
 fuse/Makefile.am   |    4 +++-
 images/Makefile.am |    2 ++
 ocaml/Makefile.am  |   10 +++++++---
 perl/Makefile.am   |   10 ++++++++--
 python/Makefile.am |    8 ++++++--
 resize/Makefile.am |    2 ++
 tools/Makefile.am  |    2 ++
 11 files changed, 40 insertions(+), 9 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index ca31727..1c5e873 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -30,7 +30,10 @@ SUBDIRS += appliance
 endif
 
 # Tests and the test-tool.
-SUBDIRS += gnulib/tests capitests caution regressions test-tool
+SUBDIRS += gnulib/tests test-tool
+if ENABLE_APPLIANCE
+SUBDIRS += capitests caution regressions
+endif
 
 # Guestfish.
 SUBDIRS += fish
diff --git a/cat/Makefile.am b/cat/Makefile.am
index 6022cd6..49320c6 100644
--- a/cat/Makefile.am
+++ b/cat/Makefile.am
@@ -136,4 +136,6 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
+endif ENABLE_APPLIANCE
diff --git a/df/Makefile.am b/df/Makefile.am
index 88e32af..209d7ae 100644
--- a/df/Makefile.am
+++ b/df/Makefile.am
@@ -82,4 +82,6 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-df.sh
+endif ENABLE_APPLIANCE
diff --git a/edit/Makefile.am b/edit/Makefile.am
index e33b33c..4fec4e1 100644
--- a/edit/Makefile.am
+++ b/edit/Makefile.am
@@ -74,4 +74,6 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-edit.sh
+endif ENABLE_APPLIANCE
diff --git a/fuse/Makefile.am b/fuse/Makefile.am
index b7558ee..5439011 100644
--- a/fuse/Makefile.am
+++ b/fuse/Makefile.am
@@ -74,8 +74,10 @@ stamp-guestmount.pod: guestmount.pod
 
 # Tests.
 
+if ENABLE_APPLIANCE
 TESTS = test-fuse.sh
+endif ENABLE_APPLIANCE
 TESTS_ENVIRONMENT = \
 	top_builddir=..
 
-endif
+endif HAVE_FUSE
diff --git a/images/Makefile.am b/images/Makefile.am
index 68eb550..956e242 100644
--- a/images/Makefile.am
+++ b/images/Makefile.am
@@ -56,7 +56,9 @@ noinst_DATA = test.iso
 
 # This is 'check_DATA' because we don't need it until 'make check'
 # time and we need the tools we have built in order to make it.
+if ENABLE_APPLIANCE
 check_DATA = debian.img fedora.img ubuntu.img windows.img
+endif ENABLE_APPLIANCE
 
 CLEANFILES = \
 	test.iso test.sqsh \
diff --git a/ocaml/Makefile.am b/ocaml/Makefile.am
index 5813f84..ec419ef 100644
--- a/ocaml/Makefile.am
+++ b/ocaml/Makefile.am
@@ -75,11 +75,15 @@ TESTS_ENVIRONMENT = \
 
 TESTS = run-bindtests \
 	t/guestfs_005_load \
-	t/guestfs_010_basic \
-	t/guestfs_070_threads \
 	t/guestfs_080_optargs \
-	t/guestfs_400_events \
+	t/guestfs_400_events
+
+if ENABLE_APPLIANCE
+TESTS += t/guestfs_010_basic \
+	t/guestfs_070_threads \
 	t/guestfs_400_progress
+endif
+
 noinst_DATA += bindtests \
 	t/guestfs_005_load \
 	t/guestfs_010_basic \
diff --git a/perl/Makefile.am b/perl/Makefile.am
index d8167d1..6212915 100644
--- a/perl/Makefile.am
+++ b/perl/Makefile.am
@@ -48,9 +48,15 @@ src_deps: $(top_builddir)/src/libguestfs.la $(generator_built)
 test_images:
 	$(MAKE) -C $(top_builddir)/images
 
-TESTS = run-bindtests run-perl-tests
+TESTS = run-bindtests
+test_prereq = src_deps all test_images
 
-$(TESTS): src_deps all appliance test_images
+if ENABLE_APPLIANCE
+test_prereq += appliance
+TESTS += run-perl-tests
+endif
+
+$(TESTS): $(test_prereq)
 
 TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
diff --git a/python/Makefile.am b/python/Makefile.am
index 5884762..19f6e00 100644
--- a/python/Makefile.am
+++ b/python/Makefile.am
@@ -50,6 +50,10 @@ TESTS_ENVIRONMENT = \
 	PYTHONPATH=$(builddir):$(builddir)/.libs \
 	TMPDIR=$(top_builddir)
 
-TESTS = run-bindtests run-python-tests
+TESTS = run-bindtests
 
-endif
+if ENABLE_APPLIANCE
+TESTS += run-python-tests
+endif ENABLE_APPLIANCE
+
+endif HAVE_PYTHON
diff --git a/resize/Makefile.am b/resize/Makefile.am
index fd7f71a..1ed0d96 100644
--- a/resize/Makefile.am
+++ b/resize/Makefile.am
@@ -86,7 +86,9 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-resize.sh
+endif
 
 # Dependencies.
 depend: .depend
diff --git a/tools/Makefile.am b/tools/Makefile.am
index 6059d35..357459b 100644
--- a/tools/Makefile.am
+++ b/tools/Makefile.am
@@ -64,9 +64,11 @@ TESTS_ENVIRONMENT = \
 	TMPDIR=$(top_builddir) \
 	PERL5LIB=$(top_builddir)/perl/blib/lib:$(top_builddir)/perl/blib/arch
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-list-filesystems.sh \
 	test-virt-make-fs.sh \
 	test-virt-tar.sh
+endif ENABLE_APPLIANCE
 
 endif
 
-- 
