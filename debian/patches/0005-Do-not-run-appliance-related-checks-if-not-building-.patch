From: Hilko Bengen <bengen@debian.org>
Date: Thu, 21 Jul 2011 09:01:19 +0200
Subject: Do not run appliance-related checks if not building appliance

---
 Makefile.am        |    5 ++++-
 cat/Makefile.am    |    2 ++
 df/Makefile.am     |    2 ++
 edit/Makefile.am   |    2 ++
 fuse/Makefile.am   |    4 +++-
 images/Makefile.am |    2 ++
 ocaml/Makefile.am  |   10 +++++++---
 perl/Makefile.am   |   10 ++++++++--
 python/Makefile.am |    8 ++++++--
 resize/Makefile.am |    2 ++
 tools/Makefile.am  |    2 ++
 11 files changed, 40 insertions(+), 9 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index ca31727..1c5e873 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -30,7 +30,10 @@ SUBDIRS += appliance
 endif
 
 # Tests and the test-tool.
-SUBDIRS += gnulib/tests capitests caution regressions test-tool
+SUBDIRS += gnulib/tests test-tool
+if ENABLE_APPLIANCE
+SUBDIRS += capitests caution regressions
+endif
 
 # Guestfish.
 SUBDIRS += fish
diff --git a/cat/Makefile.am b/cat/Makefile.am
index bf1d57c..7796675 100644
--- a/cat/Makefile.am
+++ b/cat/Makefile.am
@@ -135,4 +135,6 @@ TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
+endif ENABLE_APPLIANCE
diff --git a/df/Makefile.am b/df/Makefile.am
index 1711798..59350ff 100644
--- a/df/Makefile.am
+++ b/df/Makefile.am
@@ -81,4 +81,6 @@ TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-df.sh
+endif ENABLE_APPLIANCE
diff --git a/edit/Makefile.am b/edit/Makefile.am
index 62b5376..c1f1272 100644
--- a/edit/Makefile.am
+++ b/edit/Makefile.am
@@ -73,4 +73,6 @@ TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-edit.sh
+endif ENABLE_APPLIANCE
diff --git a/fuse/Makefile.am b/fuse/Makefile.am
index b7558ee..5439011 100644
--- a/fuse/Makefile.am
+++ b/fuse/Makefile.am
@@ -74,8 +74,10 @@ stamp-guestmount.pod: guestmount.pod
 
 # Tests.
 
+if ENABLE_APPLIANCE
 TESTS = test-fuse.sh
+endif ENABLE_APPLIANCE
 TESTS_ENVIRONMENT = \
 	top_builddir=..
 
-endif
+endif HAVE_FUSE
diff --git a/images/Makefile.am b/images/Makefile.am
index 622d288..45df114 100644
--- a/images/Makefile.am
+++ b/images/Makefile.am
@@ -56,7 +56,9 @@ noinst_DATA = test.iso
 
 # This is 'check_DATA' because we don't need it until 'make check'
 # time and we need the tools we have built in order to make it.
+if ENABLE_APPLIANCE
 check_DATA = debian.img fedora.img ubuntu.img windows.img
+endif ENABLE_APPLIANCE
 
 CLEANFILES = \
 	test.iso test.sqsh \
diff --git a/ocaml/Makefile.am b/ocaml/Makefile.am
index 252a337..d594b77 100644
--- a/ocaml/Makefile.am
+++ b/ocaml/Makefile.am
@@ -74,11 +74,15 @@ TESTS_ENVIRONMENT = \
 
 TESTS = run-bindtests \
 	t/guestfs_005_load \
-	t/guestfs_010_basic \
-	t/guestfs_070_threads \
 	t/guestfs_080_optargs \
-	t/guestfs_400_events \
+	t/guestfs_400_events
+
+if ENABLE_APPLIANCE
+TESTS += t/guestfs_010_basic \
+	t/guestfs_070_threads \
 	t/guestfs_400_progress
+endif
+
 noinst_DATA += bindtests \
 	t/guestfs_005_load \
 	t/guestfs_010_basic \
diff --git a/perl/Makefile.am b/perl/Makefile.am
index c192290..3e1c99a 100644
--- a/perl/Makefile.am
+++ b/perl/Makefile.am
@@ -48,9 +48,15 @@ src_deps: $(top_builddir)/src/libguestfs.la $(generator_built)
 test_images:
 	$(MAKE) -C $(top_builddir)/images
 
-TESTS = run-bindtests run-perl-tests
+TESTS = run-bindtests
+test_prereq = src_deps all test_images
 
-$(TESTS): src_deps all appliance test_images
+if ENABLE_APPLIANCE
+test_prereq += appliance
+TESTS += run-perl-tests
+endif
+
+$(TESTS): $(test_prereq)
 
 TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
diff --git a/python/Makefile.am b/python/Makefile.am
index e995927..94c400f 100644
--- a/python/Makefile.am
+++ b/python/Makefile.am
@@ -49,6 +49,10 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	PYTHONPATH=$(builddir):$(builddir)/.libs
 
-TESTS = run-bindtests run-python-tests
+TESTS = run-bindtests
 
-endif
+if ENABLE_APPLIANCE
+TESTS += run-python-tests
+endif ENABLE_APPLIANCE
+
+endif HAVE_PYTHON
diff --git a/resize/Makefile.am b/resize/Makefile.am
index 8418cb4..41749ba 100644
--- a/resize/Makefile.am
+++ b/resize/Makefile.am
@@ -85,7 +85,9 @@ TESTS_ENVIRONMENT = \
 	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-resize.sh
+endif
 
 # Dependencies.
 depend: .depend
diff --git a/tools/Makefile.am b/tools/Makefile.am
index 7904f1c..04a4bba 100644
--- a/tools/Makefile.am
+++ b/tools/Makefile.am
@@ -63,9 +63,11 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	PERL5LIB=$(top_builddir)/perl/blib/lib:$(top_builddir)/perl/blib/arch
 
+if ENABLE_APPLIANCE
 TESTS = test-virt-list-filesystems.sh \
 	test-virt-make-fs.sh \
 	test-virt-tar.sh
+endif ENABLE_APPLIANCE
 
 endif
 
-- 
