From: Hilko Bengen <bengen@debian.org>
Date: Sat, 20 Aug 2011 20:43:22 +0200
Subject: autoreconf

---
 Makefile.in                 |   42 ++++++++++----------
 aclocal.m4                  |   14 ++++---
 appliance/Makefile.in       |    1 +
 cat/Makefile.in             |    8 ++--
 configure                   |   91 +++++++++++++++++++++++++------------------
 daemon/Makefile.in          |    4 +-
 df/Makefile.in              |    4 +-
 edit/Makefile.in            |    4 +-
 examples/Makefile.in        |   10 ++--
 fish/Makefile.in            |   14 +++---
 fuse/Makefile.in            |    4 +-
 generator/Makefile.in       |    8 ++--
 images/Makefile.in          |   16 +++----
 inspector/Makefile.in       |    2 +-
 java/examples/Makefile.in   |    6 +-
 ocaml/Makefile.in           |   39 +++++++++---------
 ocaml/examples/Makefile.in  |    6 +-
 perl/Makefile.in            |    8 +++-
 perl/examples/Makefile.in   |    6 +-
 po-docs/ja/Makefile.in      |   18 ++++----
 po-docs/uk/Makefile.in      |   18 ++++----
 python/Makefile.in          |    5 +-
 python/examples/Makefile.in |    6 +-
 rescue/Makefile.in          |    2 +-
 resize/Makefile.in          |    4 +-
 ruby/examples/Makefile.in   |    6 +-
 src/Makefile.in             |   14 +++---
 test-tool/Makefile.in       |    2 +-
 tools/Makefile.in           |   10 ++--
 29 files changed, 196 insertions(+), 176 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index 2eaf55f..7066536 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -70,7 +70,7 @@ host_triplet = @host@
 DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(srcdir)/config.h.in \
 	$(srcdir)/libguestfs.pc.in $(srcdir)/podwrapper.sh.in \
-	$(top_srcdir)/configure $(top_srcdir)/debian/changelog.in \
+	$(srcdir)/run.in $(top_srcdir)/configure \
 	$(top_srcdir)/subdir-rules.mk ABOUT-NLS AUTHORS COPYING \
 	COPYING.LIB ChangeLog TODO build-aux/compile \
 	build-aux/config.guess build-aux/config.rpath \
@@ -78,25 +78,26 @@ DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
 	build-aux/ltmain.sh build-aux/missing
 @ENABLE_DAEMON_TRUE@am__append_1 = daemon
 @ENABLE_APPLIANCE_TRUE@am__append_2 = appliance
+@ENABLE_APPLIANCE_TRUE@am__append_3 = capitests caution regressions
 
 # Language bindings.
-@HAVE_PERL_TRUE@am__append_3 = perl perl/examples
-@HAVE_OCAML_TRUE@am__append_4 = ocaml ocaml/examples
-@HAVE_PYTHON_TRUE@am__append_5 = python python/examples
-@HAVE_RUBY_TRUE@am__append_6 = ruby ruby/examples
-@HAVE_JAVA_TRUE@am__append_7 = java java/examples
-@HAVE_HASKELL_TRUE@am__append_8 = haskell
-@HAVE_PHP_TRUE@am__append_9 = php
+@HAVE_PERL_TRUE@am__append_4 = perl perl/examples
+@HAVE_OCAML_TRUE@am__append_5 = ocaml ocaml/examples
+@HAVE_PYTHON_TRUE@am__append_6 = python python/examples
+@HAVE_RUBY_TRUE@am__append_7 = ruby ruby/examples
+@HAVE_JAVA_TRUE@am__append_8 = java java/examples
+@HAVE_HASKELL_TRUE@am__append_9 = haskell
+@HAVE_PHP_TRUE@am__append_10 = php
 
 # virt-resize 2.0 is written in OCaml.
-@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@am__append_10 = resize
+@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@am__append_11 = resize
 
 # Perl tools and guestmount.
-@HAVE_TOOLS_TRUE@am__append_11 = tools
-@HAVE_FUSE_TRUE@am__append_12 = fuse
+@HAVE_TOOLS_TRUE@am__append_12 = tools
+@HAVE_FUSE_TRUE@am__append_13 = fuse
 
 # po-docs must come after tools, inspector.
-@HAVE_PO4A_TRUE@am__append_13 = po-docs
+@HAVE_PO4A_TRUE@am__append_14 = po-docs
 subdir = .
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -196,7 +197,7 @@ am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
  configure.lineno config.status.lineno
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = config.h
-CONFIG_CLEAN_FILES = podwrapper.sh debian/changelog libguestfs.pc
+CONFIG_CLEAN_FILES = podwrapper.sh run libguestfs.pc
 CONFIG_CLEAN_VPATH_FILES =
 AM_V_GEN = $(am__v_GEN_$(V))
 am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
@@ -244,7 +245,7 @@ AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
 ETAGS = etags
 CTAGS = ctags
 DIST_SUBDIRS = gnulib/lib images generator src examples po daemon \
-	appliance gnulib/tests capitests caution regressions test-tool \
+	appliance gnulib/tests test-tool capitests caution regressions \
 	fish cat df edit inspector rescue perl perl/examples ocaml \
 	ocaml/examples python python/examples ruby ruby/examples java \
 	java/examples haskell php csharp resize tools fuse po-docs
@@ -1181,12 +1182,11 @@ ACLOCAL_AMFLAGS = -I m4
 
 # Unconditional because nothing is built yet.
 SUBDIRS = gnulib/lib images generator src examples po $(am__append_1) \
-	$(am__append_2) gnulib/tests capitests caution regressions \
-	test-tool fish cat df edit inspector rescue $(am__append_3) \
-	$(am__append_4) $(am__append_5) $(am__append_6) \
-	$(am__append_7) $(am__append_8) $(am__append_9) csharp \
-	$(am__append_10) $(am__append_11) $(am__append_12) \
-	$(am__append_13)
+	$(am__append_2) gnulib/tests test-tool $(am__append_3) fish \
+	cat df edit inspector rescue $(am__append_4) $(am__append_5) \
+	$(am__append_6) $(am__append_7) $(am__append_8) \
+	$(am__append_9) $(am__append_10) csharp $(am__append_11) \
+	$(am__append_12) $(am__append_13) $(am__append_14)
 EXTRA_DIST = \
 	$(generator_built) \
 	BUGS HACKING RELEASE-NOTES ROADMAP TODO \
@@ -1331,7 +1331,7 @@ distclean-hdr:
 	-rm -f config.h stamp-h1
 podwrapper.sh: $(top_builddir)/config.status $(srcdir)/podwrapper.sh.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
-debian/changelog: $(top_builddir)/config.status $(top_srcdir)/debian/changelog.in
+run: $(top_builddir)/config.status $(srcdir)/run.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
 libguestfs.pc: $(top_builddir)/config.status $(srcdir)/libguestfs.pc.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
diff --git a/aclocal.m4 b/aclocal.m4
index 7ee8e1e..faf58b0 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -47,7 +47,8 @@ To do so, use the procedure documented by the package, typically `autoreconf'.])
 # ----------------------------------
 AC_DEFUN([PKG_PROG_PKG_CONFIG],
 [m4_pattern_forbid([^_?PKG_[A-Z_]+$])
-m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
+m4_pattern_allow([^PKG_CONFIG(_(PATH|LIBDIR|SYSROOT_DIR|ALLOW_SYSTEM_(CFLAGS|LIBS)))?$])
+m4_pattern_allow([^PKG_CONFIG_(DISABLE_UNINSTALLED|TOP_BUILD_DIR|DEBUG_SPEW)$])
 AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])
 AC_ARG_VAR([PKG_CONFIG_PATH], [directories to add to pkg-config's search path])
 AC_ARG_VAR([PKG_CONFIG_LIBDIR], [path overriding pkg-config's built-in search path])
@@ -93,7 +94,8 @@ m4_define([_PKG_CONFIG],
     pkg_cv_[]$1="$$1"
  elif test -n "$PKG_CONFIG"; then
     PKG_CHECK_EXISTS([$3],
-                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
+                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes ],
 		     [pkg_failed=yes])
  else
     pkg_failed=untried
@@ -141,9 +143,9 @@ if test $pkg_failed = yes; then
    	AC_MSG_RESULT([no])
         _PKG_SHORT_ERRORS_SUPPORTED
         if test $_pkg_short_errors_supported = yes; then
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "$2" 2>&1`
         else 
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "$2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
@@ -156,7 +158,7 @@ $$1_PKG_ERRORS
 Consider adjusting the PKG_CONFIG_PATH environment variable if you
 installed software in a non-standard prefix.
 
-_PKG_TEXT])
+_PKG_TEXT])[]dnl
         ])
 elif test $pkg_failed = untried; then
      	AC_MSG_RESULT([no])
@@ -167,7 +169,7 @@ path to pkg-config.
 
 _PKG_TEXT
 
-To get pkg-config, see <http://pkg-config.freedesktop.org/>.])
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.])[]dnl
         ])
 else
 	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
diff --git a/appliance/Makefile.in b/appliance/Makefile.in
index 799a39c..ce88122 100644
--- a/appliance/Makefile.in
+++ b/appliance/Makefile.in
@@ -1392,6 +1392,7 @@ supermin.d/daemon.img: ../daemon/guestfsd
 	mv $@-t $@
 
 supermin.d/init.img: init
+	cmp -s $(srcdir)/init $(builddir)/init || cp $(srcdir)/init $(builddir)/init
 	mkdir -p supermin.d
 	rm -f $@ $@-t
 	echo "init" | cpio --quiet -o -H newc > $@-t
diff --git a/cat/Makefile.in b/cat/Makefile.in
index 05ba2ae..e53b774 100644
--- a/cat/Makefile.in
+++ b/cat/Makefile.in
@@ -1244,7 +1244,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
 all: all-am
 
 .SUFFIXES:
@@ -2049,7 +2049,7 @@ appliance: force
 virt-cat.1 $(top_builddir)/html/virt-cat.1.html: stamp-virt-cat.pod
 
 stamp-virt-cat.pod: virt-cat.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-cat.1 \
 	  --html $(top_builddir)/html/virt-cat.1.html \
 	  $<
@@ -2058,7 +2058,7 @@ stamp-virt-cat.pod: virt-cat.pod
 virt-ls.1 $(top_builddir)/html/virt-ls.1.html: stamp-virt-ls.pod
 
 stamp-virt-ls.pod: virt-ls.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-ls.1 \
 	  --html $(top_builddir)/html/virt-ls.1.html \
 	  $<
@@ -2067,7 +2067,7 @@ stamp-virt-ls.pod: virt-ls.pod
 virt-filesystems.1 $(top_builddir)/html/virt-filesystems.1.html: stamp-virt-filesystems.pod
 
 stamp-virt-filesystems.pod: virt-filesystems.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-filesystems.1 \
 	  --html $(top_builddir)/html/virt-filesystems.1.html \
 	  $<
diff --git a/configure b/configure
index 4a72439..c1b1bb5 100755
--- a/configure
+++ b/configure
@@ -36068,8 +36068,7 @@ fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $enable_appliance" >&5
 $as_echo "$enable_appliance" >&6; }
 
-if test "x$enable_appliance" = "xyes"; then
-        # Extract the first word of "febootstrap", so it can be a program name with args.
+# Extract the first word of "febootstrap", so it can be a program name with args.
 set dummy febootstrap; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
@@ -36107,12 +36106,8 @@ $as_echo "no" >&6; }
 fi
 
 
-    test "x$FEBOOTSTRAP" = "xno" &&
-        as_fn_error $? "febootstrap must be installed" "$LINENO" 5
-        $FEBOOTSTRAP --version >&5 2>&1 ||
-        as_fn_error $? "febootstrap >= 3.0 must be installed, your version is too old" "$LINENO" 5
 
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking if user requested febootstrap --yum-config option" >&5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if user requested febootstrap --yum-config option" >&5
 $as_echo_n "checking if user requested febootstrap --yum-config option... " >&6; }
 
 # Check whether --with-febootstrap-yum-config was given.
@@ -36122,26 +36117,32 @@ else
   FEBOOTSTRAP_YUM_CONFIG=no
 fi
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $FEBOOTSTRAP_YUM_CONFIG" >&5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $FEBOOTSTRAP_YUM_CONFIG" >&5
 $as_echo "$FEBOOTSTRAP_YUM_CONFIG" >&6; }
 
 
-                            { $as_echo "$as_me:${as_lineno-$LINENO}: checking which Linux distro for package names" >&5
+if test "x$enable_appliance" = "xyes"; then
+    test "x$FEBOOTSTRAP" = "xno" &&
+        as_fn_error $? "febootstrap must be installed" "$LINENO" 5
+        $FEBOOTSTRAP --version >&5 2>&1 ||
+        as_fn_error $? "febootstrap >= 3.0 must be installed, your version is too old" "$LINENO" 5
+fi
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking which Linux distro for package names" >&5
 $as_echo_n "checking which Linux distro for package names... " >&6; }
-    DISTRO=REDHAT
-    if test -f /etc/debian_version; then
-        DISTRO=DEBIAN
-	if grep -q 'DISTRIB_ID=Ubuntu' /etc/lsb-release 2>&5; then
-            DISTRO=UBUNTU
-	fi
-    fi
-    if test -f /etc/arch-release; then
-        DISTRO=ARCHLINUX
+DISTRO=REDHAT
+if test -f /etc/debian_version; then
+    DISTRO=DEBIAN
+    if grep -q 'DISTRIB_ID=Ubuntu' /etc/lsb-release 2>&5; then
+        DISTRO=UBUNTU
     fi
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DISTRO" >&5
+fi
+if test -f /etc/arch-release; then
+    DISTRO=ARCHLINUX
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $DISTRO" >&5
 $as_echo "$DISTRO" >&6; }
 
-fi
 
 # Extract the first word of "rpcgen", so it can be a program name with args.
 set dummy rpcgen; ac_word=$2
@@ -38791,6 +38792,7 @@ $as_echo "#define HAVE_DCGETTEXT 1" >>confdefs.h
 
 
 
+
 if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
 	if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
@@ -38919,6 +38921,7 @@ if test -n "$PCRE_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_PCRE_CFLAGS=`$PKG_CONFIG --cflags "libpcre" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -38935,6 +38938,7 @@ if test -n "$PCRE_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_PCRE_LIBS=`$PKG_CONFIG --libs "libpcre" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -38954,9 +38958,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        PCRE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libpcre" 2>&1`
+	        PCRE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libpcre" 2>&1`
         else
-	        PCRE_PKG_ERRORS=`$PKG_CONFIG --print-errors "libpcre" 2>&1`
+	        PCRE_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libpcre" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$PCRE_PKG_ERRORS" >&5
@@ -38971,7 +38975,6 @@ installed software in a non-standard prefix.
 Alternatively, you may set the environment variables PCRE_CFLAGS
 and PCRE_LIBS to avoid the need to call pkg-config.
 See the pkg-config man page for more details." "$LINENO" 5
-
 elif test $pkg_failed = untried; then
      	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
@@ -38987,7 +38990,6 @@ See the pkg-config man page for more details.
 
 To get pkg-config, see <http://pkg-config.freedesktop.org/>.
 See \`config.log' for more details" "$LINENO" 5; }
-
 else
 	PCRE_CFLAGS=$pkg_cv_PCRE_CFLAGS
 	PCRE_LIBS=$pkg_cv_PCRE_LIBS
@@ -39066,6 +39068,7 @@ if test -n "$LIBVIRT_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBVIRT_CFLAGS=`$PKG_CONFIG --cflags "libvirt" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39082,6 +39085,7 @@ if test -n "$LIBVIRT_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBVIRT_LIBS=`$PKG_CONFIG --libs "libvirt" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39101,9 +39105,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libvirt" 2>&1`
+	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libvirt" 2>&1`
         else
-	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --print-errors "libvirt" 2>&1`
+	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libvirt" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBVIRT_PKG_ERRORS" >&5
@@ -39151,6 +39155,7 @@ if test -n "$LIBXML2_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_CFLAGS=`$PKG_CONFIG --cflags "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39167,6 +39172,7 @@ if test -n "$LIBXML2_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_LIBS=`$PKG_CONFIG --libs "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39186,9 +39192,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libxml-2.0" 2>&1`
         else
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libxml-2.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBXML2_PKG_ERRORS" >&5
@@ -39236,6 +39242,7 @@ if test -n "$LIBCONFIG_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBCONFIG_CFLAGS=`$PKG_CONFIG --cflags "libconfig" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39252,6 +39259,7 @@ if test -n "$LIBCONFIG_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBCONFIG_LIBS=`$PKG_CONFIG --libs "libconfig" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39271,9 +39279,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libconfig" 2>&1`
+	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libconfig" 2>&1`
         else
-	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --print-errors "libconfig" 2>&1`
+	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libconfig" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBCONFIG_PKG_ERRORS" >&5
@@ -39321,6 +39329,7 @@ if test -n "$HIVEX_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_HIVEX_CFLAGS=`$PKG_CONFIG --cflags "hivex" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39337,6 +39346,7 @@ if test -n "$HIVEX_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_HIVEX_LIBS=`$PKG_CONFIG --libs "hivex" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39356,9 +39366,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "hivex" 2>&1`
+	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "hivex" 2>&1`
         else
-	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --print-errors "hivex" 2>&1`
+	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "hivex" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$HIVEX_PKG_ERRORS" >&5
@@ -39414,6 +39424,7 @@ if test -n "$FUSE_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_FUSE_CFLAGS=`$PKG_CONFIG --cflags "fuse" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39430,6 +39441,7 @@ if test -n "$FUSE_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_FUSE_LIBS=`$PKG_CONFIG --libs "fuse" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -39449,9 +39461,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        FUSE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "fuse" 2>&1`
+	        FUSE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "fuse" 2>&1`
         else
-	        FUSE_PKG_ERRORS=`$PKG_CONFIG --print-errors "fuse" 2>&1`
+	        FUSE_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "fuse" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$FUSE_PKG_ERRORS" >&5
@@ -40678,13 +40690,13 @@ fi
         if test "x$PYTHON" != "xno"; then
 	    { $as_echo "$as_me:${as_lineno-$LINENO}: checking Python prefix" >&5
 $as_echo_n "checking Python prefix... " >&6; }
-            PYTHON_PREFIX=`$PYTHON -c "import sys; print sys.prefix"`
+            PYTHON_PREFIX=`$PYTHON -c "import sys; print (sys.prefix)"`
 	    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_PREFIX" >&5
 $as_echo "$PYTHON_PREFIX" >&6; }
 
 	    { $as_echo "$as_me:${as_lineno-$LINENO}: checking Python version" >&5
 $as_echo_n "checking Python version... " >&6; }
-            PYTHON_VERSION=`$PYTHON -c "import sys; print sys.version[0:3]"`
+            PYTHON_VERSION=`$PYTHON -c "import sys; print (sys.version[0:3])"`
 	    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON_VERSION" >&5
 $as_echo "$PYTHON_VERSION" >&6; }
 
@@ -41221,7 +41233,9 @@ ac_config_headers="$ac_config_headers config.h"
 
 ac_config_files="$ac_config_files podwrapper.sh"
 
-ac_config_files="$ac_config_files Makefile appliance/Makefile capitests/Makefile cat/Makefile caution/Makefile csharp/Makefile debian/changelog df/Makefile edit/Makefile examples/Makefile fish/Makefile fuse/Makefile generator/Makefile gnulib/lib/Makefile gnulib/tests/Makefile haskell/Makefile images/Makefile inspector/Makefile java/Makefile java/examples/Makefile libguestfs.pc ocaml/META ocaml/Makefile ocaml/examples/Makefile perl/Makefile perl/Makefile.PL perl/examples/Makefile php/Makefile po-docs/Makefile po-docs/ja/Makefile po-docs/uk/Makefile po/Makefile.in python/Makefile python/examples/Makefile regressions/Makefile rescue/Makefile resize/Makefile ruby/Makefile ruby/Rakefile ruby/examples/Makefile src/Makefile test-tool/Makefile tools/Makefile"
+ac_config_files="$ac_config_files run"
+
+ac_config_files="$ac_config_files Makefile appliance/Makefile capitests/Makefile cat/Makefile caution/Makefile csharp/Makefile df/Makefile edit/Makefile examples/Makefile fish/Makefile fuse/Makefile generator/Makefile gnulib/lib/Makefile gnulib/tests/Makefile haskell/Makefile images/Makefile inspector/Makefile java/Makefile java/examples/Makefile libguestfs.pc ocaml/META ocaml/Makefile ocaml/examples/Makefile perl/Makefile perl/Makefile.PL perl/examples/Makefile php/Makefile po-docs/Makefile po-docs/ja/Makefile po-docs/uk/Makefile po/Makefile.in python/Makefile python/examples/Makefile regressions/Makefile rescue/Makefile resize/Makefile ruby/Makefile ruby/Rakefile ruby/examples/Makefile src/Makefile test-tool/Makefile tools/Makefile"
 
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
@@ -42401,13 +42415,13 @@ do
     "po-directories") CONFIG_COMMANDS="$CONFIG_COMMANDS po-directories" ;;
     "config.h") CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
     "podwrapper.sh") CONFIG_FILES="$CONFIG_FILES podwrapper.sh" ;;
+    "run") CONFIG_FILES="$CONFIG_FILES run" ;;
     "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
     "appliance/Makefile") CONFIG_FILES="$CONFIG_FILES appliance/Makefile" ;;
     "capitests/Makefile") CONFIG_FILES="$CONFIG_FILES capitests/Makefile" ;;
     "cat/Makefile") CONFIG_FILES="$CONFIG_FILES cat/Makefile" ;;
     "caution/Makefile") CONFIG_FILES="$CONFIG_FILES caution/Makefile" ;;
     "csharp/Makefile") CONFIG_FILES="$CONFIG_FILES csharp/Makefile" ;;
-    "debian/changelog") CONFIG_FILES="$CONFIG_FILES debian/changelog" ;;
     "df/Makefile") CONFIG_FILES="$CONFIG_FILES df/Makefile" ;;
     "edit/Makefile") CONFIG_FILES="$CONFIG_FILES edit/Makefile" ;;
     "examples/Makefile") CONFIG_FILES="$CONFIG_FILES examples/Makefile" ;;
@@ -43911,6 +43925,7 @@ fi
       esac
     done ;;
     "podwrapper.sh":F) chmod +x podwrapper.sh ;;
+    "run":F) chmod +x run ;;
 
   esac
 done # for ac_tag
diff --git a/daemon/Makefile.in b/daemon/Makefile.in
index ab188ca..fa13869 100644
--- a/daemon/Makefile.in
+++ b/daemon/Makefile.in
@@ -3126,10 +3126,10 @@ $(generator_built): $(generatorsrcdir)/stamp-generator
 $(generatorsrcdir)/stamp-generator: force
 	$(MAKE) -C $(generatorsrcdir) stamp-generator
 
-guestfs_protocol.c: $(libsrcdir)/guestfs_protocol.c
+guestfs_protocol.c: $(srcdir)/guestfs_protocol.c
 	rm -f $@
 	ln $< $@
-guestfs_protocol.h: $(libsrcdir)/guestfs_protocol.h
+guestfs_protocol.h: $(srcdir)/guestfs_protocol.h
 	rm -f $@
 	ln $< $@
 $(libsrcdir)/guestfs_protocol.c: force
diff --git a/df/Makefile.in b/df/Makefile.in
index 5675a8d..e484854 100644
--- a/df/Makefile.in
+++ b/df/Makefile.in
@@ -1184,7 +1184,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-df.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-df.sh
 all: all-am
 
 .SUFFIXES:
@@ -1830,7 +1830,7 @@ appliance: force
 virt-df.1 $(top_builddir)/html/virt-df.1.html: stamp-virt-df.pod
 
 stamp-virt-df.pod: virt-df.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-df.1 \
 	  --html $(top_builddir)/html/virt-df.1.html \
 	  $<
diff --git a/edit/Makefile.in b/edit/Makefile.in
index f0aa0a1..667f0bf 100644
--- a/edit/Makefile.in
+++ b/edit/Makefile.in
@@ -1173,7 +1173,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-edit.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-edit.sh
 all: all-am
 
 .SUFFIXES:
@@ -1768,7 +1768,7 @@ appliance: force
 virt-edit.1 $(top_builddir)/html/virt-edit.1.html: stamp-virt-edit.pod
 
 stamp-virt-edit.pod: virt-edit.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-edit.1 \
 	  --html $(top_builddir)/html/virt-edit.1.html \
 	  $<
diff --git a/examples/Makefile.in b/examples/Makefile.in
index 8c3755f..fb2b708 100644
--- a/examples/Makefile.in
+++ b/examples/Makefile.in
@@ -1611,19 +1611,19 @@ uninstall-man: uninstall-man1 uninstall-man3
 guestfs-examples.3 $(top_builddir)/html/guestfs-examples.3.html: stamp-guestfs-examples.pod
 
 stamp-guestfs-examples.pod: guestfs-examples.pod create_disk.c inspect_vm.c
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-examples.3 \
 	  --html $(top_builddir)/html/guestfs-examples.3.html \
-	  --verbatim create_disk.c:@EXAMPLE1@ \
-	  --verbatim inspect_vm.c:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/create_disk.c:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/inspect_vm.c:@EXAMPLE2@ \
 	  $<
 	touch $@
 
 guestfs-recipes.1 $(top_builddir)/html/guestfs-recipes.1.html: stamp-guestfs-recipes.pod
 
-stamp-guestfs-recipes.pod: guestfs-recipes.pod create_disk.c inspect_vm.c
-	$(top_srcdir)/podwrapper.sh \
+stamp-guestfs-recipes.pod: guestfs-recipes.pod
+	$(top_builddir)/podwrapper.sh \
 	  --section 1 \
 	  --man guestfs-recipes.1 \
 	  --html $(top_builddir)/html/guestfs-recipes.1.html \
diff --git a/fish/Makefile.in b/fish/Makefile.in
index 3a1b9b2..0cd95ab 100644
--- a/fish/Makefile.in
+++ b/fish/Makefile.in
@@ -2391,18 +2391,18 @@ cmds_gperf.c: cmds_gperf.gperf
 guestfish.1 $(top_builddir)/html/guestfish.1.html: stamp-guestfish.pod
 
 stamp-guestfish.pod: guestfish.pod guestfish-actions.pod guestfish-commands.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man guestfish.1 \
 	  --html $(top_builddir)/html/guestfish.1.html \
-	  --insert guestfish-actions.pod:@ACTIONS@ \
-	  --insert guestfish-commands.pod:@FISH_COMMANDS@ \
+	  --insert $(srcdir)/guestfish-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfish-commands.pod:@FISH_COMMANDS@ \
 	  $<
 	touch $@
 
 virt-copy-in.1 $(top_builddir)/html/virt-copy-in.1.html: stamp-virt-copy-in.pod
 
 stamp-virt-copy-in.pod: virt-copy-in.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-copy-in.1 \
 	  --html $(top_builddir)/html/virt-copy-in.1.html \
 	  $<
@@ -2411,7 +2411,7 @@ stamp-virt-copy-in.pod: virt-copy-in.pod
 virt-copy-out.1 $(top_builddir)/html/virt-copy-out.1.html: stamp-virt-copy-out.pod
 
 stamp-virt-copy-out.pod: virt-copy-out.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-copy-out.1 \
 	  --html $(top_builddir)/html/virt-copy-out.1.html \
 	  $<
@@ -2420,7 +2420,7 @@ stamp-virt-copy-out.pod: virt-copy-out.pod
 virt-tar-in.1 $(top_builddir)/html/virt-tar-in.1.html: stamp-virt-tar-in.pod
 
 stamp-virt-tar-in.pod: virt-tar-in.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-tar-in.1 \
 	  --html $(top_builddir)/html/virt-tar-in.1.html \
 	  $<
@@ -2429,7 +2429,7 @@ stamp-virt-tar-in.pod: virt-tar-in.pod
 virt-tar-out.1 $(top_builddir)/html/virt-tar-out.1.html: stamp-virt-tar-out.pod
 
 stamp-virt-tar-out.pod: virt-tar-out.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-tar-out.1 \
 	  --html $(top_builddir)/html/virt-tar-out.1.html \
 	  $<
diff --git a/fuse/Makefile.in b/fuse/Makefile.in
index 9d271ba..bd53845 100644
--- a/fuse/Makefile.in
+++ b/fuse/Makefile.in
@@ -1180,7 +1180,7 @@ CLEANFILES = stamp-guestmount.pod
 @HAVE_FUSE_TRUE@noinst_DATA = $(top_builddir)/html/guestmount.1.html
 
 # Tests.
-@HAVE_FUSE_TRUE@TESTS = test-fuse.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_FUSE_TRUE@TESTS = test-fuse.sh
 @HAVE_FUSE_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_FUSE_TRUE@	top_builddir=..
 
@@ -1795,7 +1795,7 @@ appliance: force
 @HAVE_FUSE_TRUE@guestmount.1 $(top_builddir)/html/guestmount.1.html: stamp-guestmount.pod
 
 @HAVE_FUSE_TRUE@stamp-guestmount.pod: guestmount.pod
-@HAVE_FUSE_TRUE@	$(top_srcdir)/podwrapper.sh \
+@HAVE_FUSE_TRUE@	$(top_builddir)/podwrapper.sh \
 @HAVE_FUSE_TRUE@	  --man guestmount.1 \
 @HAVE_FUSE_TRUE@	  --html $(top_builddir)/html/guestmount.1.html \
 @HAVE_FUSE_TRUE@	  $<
diff --git a/generator/Makefile.in b/generator/Makefile.in
index 0ffc04f..d7dbc16 100644
--- a/generator/Makefile.in
+++ b/generator/Makefile.in
@@ -1276,14 +1276,14 @@ uninstall-am:
 	mostlyclean-libtool pdf pdf-am ps ps-am uninstall uninstall-am
 
 
-@HAVE_OCAML_TRUE@generator: $(OBJECTS)
-@HAVE_OCAML_TRUE@	$(OCAMLC) -o generator $(OCAMLCFLAGS) $(OCAMLCLIBS) $(OBJECTS)
+@HAVE_OCAML_TRUE@$(srcdir)/generator: $(OBJECTS)
+@HAVE_OCAML_TRUE@	$(OCAMLC) -I $(srcdir) -o $@ $(OCAMLCFLAGS) $(OCAMLCLIBS) $(OBJECTS)
 
 @HAVE_OCAML_TRUE@.ml.cmo:
-@HAVE_OCAML_TRUE@	$(OCAMLC) $(OCAMLCFLAGS) -c $< -o $@
+@HAVE_OCAML_TRUE@	$(OCAMLC) -I $(srcdir) $(OCAMLCFLAGS) -c $< -o $@
 
 @HAVE_OCAML_TRUE@.mli.cmi:
-@HAVE_OCAML_TRUE@	$(OCAMLC) $(OCAMLCFLAGS) -c $< -o $@
+@HAVE_OCAML_TRUE@	$(OCAMLC) -I $(srcdir) $(OCAMLCFLAGS) -c $< -o $@
 
 @HAVE_OCAML_TRUE@depend: .depend
 
diff --git a/images/Makefile.in b/images/Makefile.in
index c9adda6..35ed8ca 100644
--- a/images/Makefile.in
+++ b/images/Makefile.in
@@ -1099,7 +1099,7 @@ noinst_DATA = test.iso
 
 # This is 'check_DATA' because we don't need it until 'make check'
 # time and we need the tools we have built in order to make it.
-check_DATA = debian.img fedora.img ubuntu.img windows.img
+@ENABLE_APPLIANCE_TRUE@check_DATA = debian.img fedora.img ubuntu.img windows.img
 CLEANFILES = \
 	test.iso test.sqsh \
 	100kallzeroes 100kallnewlines 100kallspaces 100krandom 10klines \
@@ -1426,41 +1426,39 @@ $(builddir)/test-grep.txt.gz: test-grep.txt
 fedora.img: guest-aux/make-fedora-img.sh \
 		guest-aux/fedora-name.db \
 		guest-aux/fedora-packages.db
-	LIBGUESTFS_PATH=$(top_builddir)/appliance \
-	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	TMPDIR=$(top_builddir) \
+	SRCDIR=$(srcdir) \
 	bash $<
 
 guest-aux/fedora-name.db: guest-aux/fedora-name.db.txt
 	rm -f $@ $@-t
+	mkdir -p guest-aux
 	$(DB_LOAD) $@-t < $<
 	mv $@-t $@
 
 guest-aux/fedora-packages.db: guest-aux/fedora-packages.db.txt
 	rm -f $@ $@-t
+	mkdir -p guest-aux
 	$(DB_LOAD) $@-t < $<
 	mv $@-t $@
 
 # Make a (dummy) Debian image.
 debian.img: guest-aux/make-debian-img.sh
-	LIBGUESTFS_PATH=$(top_builddir)/appliance \
-	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	TMPDIR=$(top_builddir) \
+	SRCDIR=$(srcdir) \
 	bash $<
 
 # Make a (dummy) Ubuntu image.
 ubuntu.img: guest-aux/make-ubuntu-img.sh
-	LIBGUESTFS_PATH=$(top_builddir)/appliance \
-	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	TMPDIR=$(top_builddir) \
+	SRCDIR=$(srcdir) \
 	bash $<
 
 # Make a (dummy) Windows image.
 windows.img: guest-aux/make-windows-img.sh \
 	     guest-aux/windows-software guest-aux/windows-system
-	LIBGUESTFS_PATH=$(top_builddir)/appliance \
-	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 	TMPDIR=$(top_builddir) \
+	SRCDIR=$(srcdir) \
 	bash $<
 
 # Since users might not have the tools needed to create this, we
diff --git a/inspector/Makefile.in b/inspector/Makefile.in
index 31dd84e..e5835bd 100644
--- a/inspector/Makefile.in
+++ b/inspector/Makefile.in
@@ -1813,7 +1813,7 @@ appliance: force
 @HAVE_LIBXML2_TRUE@virt-inspector.1 $(top_builddir)/html/virt-inspector.1.html: stamp-virt-inspector.pod
 
 @HAVE_LIBXML2_TRUE@stamp-virt-inspector.pod: virt-inspector.pod
-@HAVE_LIBXML2_TRUE@	$(top_srcdir)/podwrapper.sh \
+@HAVE_LIBXML2_TRUE@	$(top_builddir)/podwrapper.sh \
 @HAVE_LIBXML2_TRUE@	  --man virt-inspector.1 \
 @HAVE_LIBXML2_TRUE@	  --html $(top_builddir)/html/virt-inspector.1.html \
 @HAVE_LIBXML2_TRUE@	  $<
diff --git a/java/examples/Makefile.in b/java/examples/Makefile.in
index 600bf7c..7107c8c 100644
--- a/java/examples/Makefile.in
+++ b/java/examples/Makefile.in
@@ -1331,12 +1331,12 @@ uninstall-man: uninstall-man3
 guestfs-java.3 $(top_builddir)/html/guestfs-java.3.html: stamp-guestfs-java.pod
 
 stamp-guestfs-java.pod: guestfs-java.pod CreateDisk.java InspectVM.java
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-java.3 \
 	  --html $(top_builddir)/html/guestfs-java.3.html \
-	  --verbatim CreateDisk.java:@EXAMPLE1@ \
-	  --verbatim InspectVM.java:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/CreateDisk.java:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/InspectVM.java:@EXAMPLE2@ \
 	  $<
 	touch $@
 
diff --git a/ocaml/Makefile.in b/ocaml/Makefile.in
index 387066f..a374682 100644
--- a/ocaml/Makefile.in
+++ b/ocaml/Makefile.in
@@ -71,7 +71,11 @@ DIST_COMMON = $(srcdir)/.depend $(srcdir)/META.in \
 	$(srcdir)/Makefile.am $(srcdir)/Makefile.in \
 	$(top_srcdir)/subdir-rules.mk
 @HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@am__append_1 = html/index.html
-@HAVE_OCAML_TRUE@am__append_2 = $(noinst_DATA)
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@am__append_2 = t/guestfs_010_basic \
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@	t/guestfs_070_threads \
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@	t/guestfs_400_progress
+
+@HAVE_OCAML_TRUE@am__append_3 = $(noinst_DATA)
 subdir = ocaml
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1084,7 +1088,7 @@ EXTRA_DIST = \
 	t/*.ml
 
 CLEANFILES = *.cmi *.cmo *.cmx *.cma *.cmxa *.o *.a *.so t/*.cmi \
-	t/*.cmo t/*.cmx t/*.o t/*.a t/*.so $(am__append_2)
+	t/*.cmo t/*.cmx t/*.o t/*.a t/*.so $(am__append_3)
 AM_CPPFLAGS = -I$(top_builddir) -I$(OCAMLLIB) -I$(top_srcdir)/ocaml \
   -I$(top_srcdir)/src -I$(top_builddir)/src \
   $(WARN_CFLAGS) $(WERROR_CFLAGS)
@@ -1102,14 +1106,9 @@ AM_CPPFLAGS = -I$(top_builddir) -I$(OCAMLLIB) -I$(top_srcdir)/ocaml \
 @HAVE_OCAML_TRUE@	TMPDIR=$(top_builddir) \
 @HAVE_OCAML_TRUE@	$(VG)
 
-@HAVE_OCAML_TRUE@TESTS = run-bindtests \
-@HAVE_OCAML_TRUE@	t/guestfs_005_load \
-@HAVE_OCAML_TRUE@	t/guestfs_010_basic \
-@HAVE_OCAML_TRUE@	t/guestfs_070_threads \
-@HAVE_OCAML_TRUE@	t/guestfs_080_optargs \
-@HAVE_OCAML_TRUE@	t/guestfs_400_events \
-@HAVE_OCAML_TRUE@	t/guestfs_400_progress
-
+@HAVE_OCAML_TRUE@TESTS = run-bindtests t/guestfs_005_load \
+@HAVE_OCAML_TRUE@	t/guestfs_080_optargs t/guestfs_400_events \
+@HAVE_OCAML_TRUE@	$(am__append_2)
 @HAVE_OCAML_TRUE@SUFFIXES = .cmo .cmi .cmx .ml .mli .mll .mly
 all: all-am
 
@@ -1428,9 +1427,9 @@ appliance: force
 @HAVE_OCAML_TRUE@	$(CC) $(AM_CPPFLAGS) $(CFLAGS) -fPIC -Wall -c $<
 
 @HAVE_OCAML_TRUE@guestfs_c_actions.o: guestfs_c_actions.c
-@HAVE_OCAML_TRUE@	$(CC) $(AM_CPPFLAGS) $(CFLAGS) -fPIC -Wall -c $<
+@HAVE_OCAML_TRUE@	$(CC) $(AM_CPPFLAGS) $(CFLAGS) -fPIC -Wall -c $(srcdir)/$<
 
-@HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@html/index.html: guestfs*.mli guestfs*.ml
+@HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@html/index.html: $(srcdir)/guestfs*.mli $(srcdir)/guestfs*.ml
 @HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@	mkdir -p html
 @HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@	-$(OCAMLDOC) -d html -html $^
 
@@ -1468,14 +1467,14 @@ appliance: force
 @HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlopt -package unix,threads -thread -linkpkg -c $< -o $@
 
 @HAVE_OCAML_TRUE@t/%.cmx: t/%.ml mlguestfs.cmxa
-@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlopt -package unix -linkpkg -c $< -o $@
+@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlopt -package unix -linkpkg -c $< -o $(builddir)/$@
 
-@HAVE_OCAML_TRUE@.mli.cmi:
-@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlc -package unix -c $< -o $@
-@HAVE_OCAML_TRUE@.ml.cmo:
-@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlc -package unix -c $< -o $@
-@HAVE_OCAML_TRUE@.ml.cmx:
-@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlopt -package unix -c $< -o $@
+@HAVE_OCAML_TRUE@%.cmi: %.mli
+@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlc -package unix -c $< -o $(builddir)/$@
+@HAVE_OCAML_TRUE@%.cmo: %.ml
+@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlc -package unix -c $< -o $(builddir)/$@
+@HAVE_OCAML_TRUE@%.cmx: %.ml
+@HAVE_OCAML_TRUE@	$(OCAMLFIND) ocamlopt -package unix -c $< -o $(builddir)/$@
 
 @HAVE_OCAML_TRUE@depend: .depend
 
@@ -1496,7 +1495,7 @@ appliance: force
 @HAVE_OCAML_TRUE@	$(OCAMLFIND) install \
 @HAVE_OCAML_TRUE@	  -ldconf ignore -destdir $(DESTDIR)$(OCAMLLIB) \
 @HAVE_OCAML_TRUE@	  guestfs \
-@HAVE_OCAML_TRUE@	  META *.so *.a *.cma *.cmx *.cmxa *.cmi *.mli
+@HAVE_OCAML_TRUE@	  META *.so *.a *.cma *.cmx *.cmxa *.cmi $(srcdir)/*.mli
 
 # Tell version 3.79 and up of GNU make to not build goals in this
 # directory in parallel.  (Possible solution for RHBZ#502309).
diff --git a/ocaml/examples/Makefile.in b/ocaml/examples/Makefile.in
index 0fa57f5..c3a33e1 100644
--- a/ocaml/examples/Makefile.in
+++ b/ocaml/examples/Makefile.in
@@ -1332,12 +1332,12 @@ uninstall-man: uninstall-man3
 guestfs-ocaml.3 $(top_builddir)/html/guestfs-ocaml.3.html: stamp-guestfs-ocaml.pod
 
 stamp-guestfs-ocaml.pod: guestfs-ocaml.pod create_disk.ml inspect_vm.ml
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-ocaml.3 \
 	  --html $(top_builddir)/html/guestfs-ocaml.3.html \
-	  --verbatim create_disk.ml:@EXAMPLE1@ \
-	  --verbatim inspect_vm.ml:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/create_disk.ml:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/inspect_vm.ml:@EXAMPLE2@ \
 	  $<
 	touch $@
 
diff --git a/perl/Makefile.in b/perl/Makefile.in
index a1186ff..79dd8c4 100644
--- a/perl/Makefile.in
+++ b/perl/Makefile.in
@@ -68,6 +68,8 @@ build_triplet = @build@
 host_triplet = @host@
 DIST_COMMON = README $(srcdir)/Makefile.PL.in $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(top_srcdir)/subdir-rules.mk
+@ENABLE_APPLIANCE_TRUE@@HAVE_PERL_TRUE@am__append_1 = appliance
+@ENABLE_APPLIANCE_TRUE@@HAVE_PERL_TRUE@am__append_2 = run-perl-tests
 subdir = perl
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1080,7 +1082,8 @@ EXTRA_DIST = \
 	t/*.t \
 	typemap
 
-@HAVE_PERL_TRUE@TESTS = run-bindtests run-perl-tests
+@HAVE_PERL_TRUE@TESTS = run-bindtests $(am__append_2)
+@HAVE_PERL_TRUE@test_prereq = src_deps all test_images $(am__append_1)
 @HAVE_PERL_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_PERL_TRUE@	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 @HAVE_PERL_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
@@ -1405,12 +1408,13 @@ appliance: force
 @HAVE_PERL_TRUE@test_images:
 @HAVE_PERL_TRUE@	$(MAKE) -C $(top_builddir)/images
 
-@HAVE_PERL_TRUE@$(TESTS): src_deps all appliance test_images
+@HAVE_PERL_TRUE@$(TESTS): $(test_prereq)
 
 @HAVE_PERL_TRUE@all: Makefile-pl src_deps
 @HAVE_PERL_TRUE@	$(MAKE) -f Makefile-pl
 
 @HAVE_PERL_TRUE@Makefile-pl: Makefile.PL
+@HAVE_PERL_TRUE@	-[ $(srcdir) != $(builddir) ] && cp -rsu $(abs_srcdir)/. $(builddir)/.
 @HAVE_PERL_TRUE@	perl Makefile.PL INSTALLDIRS=$(INSTALLDIRS) PREFIX=$(prefix)
 
 # No!  Otherwise it is deleted before the clean-local rule runs.
diff --git a/perl/examples/Makefile.in b/perl/examples/Makefile.in
index 22595aa..44423bc 100644
--- a/perl/examples/Makefile.in
+++ b/perl/examples/Makefile.in
@@ -1325,12 +1325,12 @@ uninstall-man: uninstall-man3
 guestfs-perl.3 $(top_builddir)/html/guestfs-perl.3.html: stamp-guestfs-perl.pod
 
 stamp-guestfs-perl.pod: guestfs-perl.pod create_disk.pl inspect_vm.pl
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-perl.3 \
 	  --html $(top_builddir)/html/guestfs-perl.3.html \
-	  --verbatim create_disk.pl:@EXAMPLE1@ \
-	  --verbatim inspect_vm.pl:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/create_disk.pl:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/inspect_vm.pl:@EXAMPLE2@ \
 	  $<
 	touch $@
 
diff --git a/po-docs/ja/Makefile.in b/po-docs/ja/Makefile.in
index d34497e..b561f68 100644
--- a/po-docs/ja/Makefile.in
+++ b/po-docs/ja/Makefile.in
@@ -1267,26 +1267,26 @@ uninstall-am:
 all-local: $(MANPAGES)
 
 guestfs.3: guestfs.pod guestfs-actions.pod guestfs-availability.pod guestfs-structs.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man $@ \
-	  --insert guestfs-actions.pod:@ACTIONS@ \
-	  --insert guestfs-availability.pod:@AVAILABILITY@ \
-	  --insert guestfs-structs.pod:@STRUCTS@ \
+	  --insert $(srcdir)/guestfs-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfs-availability.pod:@AVAILABILITY@ \
+	  --insert $(srcdir)/guestfs-structs.pod:@STRUCTS@ \
 	  $<
 
 guestfish.1: guestfish.pod guestfish-actions.pod guestfish-commands.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man $@ \
-	  --insert guestfish-actions.pod:@ACTIONS@ \
-	  --insert guestfish-commands.pod:@FISH_COMMANDS@ \
+	  --insert $(srcdir)/guestfish-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfish-commands.pod:@FISH_COMMANDS@ \
 	  $<
 
 %.1: %.pod
-	$(top_srcdir)/podwrapper.sh --man $@ $<
+	$(top_builddir)/podwrapper.sh --man $@ $<
 
 %.1: %.pl
-	$(top_srcdir)/podwrapper.sh --man $@ $<
+	$(top_builddir)/podwrapper.sh --man $@ $<
 
 # XXX Can automake do this properly?
 install-data-hook:
diff --git a/po-docs/uk/Makefile.in b/po-docs/uk/Makefile.in
index de27c5a..8c20540 100644
--- a/po-docs/uk/Makefile.in
+++ b/po-docs/uk/Makefile.in
@@ -1267,26 +1267,26 @@ uninstall-am:
 all-local: $(MANPAGES)
 
 guestfs.3: guestfs.pod guestfs-actions.pod guestfs-availability.pod guestfs-structs.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man $@ \
-	  --insert guestfs-actions.pod:@ACTIONS@ \
-	  --insert guestfs-availability.pod:@AVAILABILITY@ \
-	  --insert guestfs-structs.pod:@STRUCTS@ \
+	  --insert $(srcdir)/guestfs-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfs-availability.pod:@AVAILABILITY@ \
+	  --insert $(srcdir)/guestfs-structs.pod:@STRUCTS@ \
 	  $<
 
 guestfish.1: guestfish.pod guestfish-actions.pod guestfish-commands.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man $@ \
-	  --insert guestfish-actions.pod:@ACTIONS@ \
-	  --insert guestfish-commands.pod:@FISH_COMMANDS@ \
+	  --insert $(srcdir)/guestfish-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfish-commands.pod:@FISH_COMMANDS@ \
 	  $<
 
 %.1: %.pod
-	$(top_srcdir)/podwrapper.sh --man $@ $<
+	$(top_builddir)/podwrapper.sh --man $@ $<
 
 %.1: %.pl
-	$(top_srcdir)/podwrapper.sh --man $@ $<
+	$(top_builddir)/podwrapper.sh --man $@ $<
 
 # XXX Can automake do this properly?
 install-data-hook:
diff --git a/python/Makefile.in b/python/Makefile.in
index 1e73bf1..97948c8 100644
--- a/python/Makefile.in
+++ b/python/Makefile.in
@@ -70,6 +70,7 @@ build_triplet = @build@
 host_triplet = @host@
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
 	$(top_srcdir)/subdir-rules.mk
+@ENABLE_APPLIANCE_TRUE@@HAVE_PYTHON_TRUE@am__append_1 = run-python-tests
 subdir = python
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1146,13 +1147,13 @@ EXTRA_DIST = \
 @HAVE_PYTHON_TRUE@			  -I$(top_srcdir)/src -I$(top_builddir)/src
 
 @HAVE_PYTHON_TRUE@libguestfsmod_la_LIBADD = $(top_builddir)/src/libguestfs.la
-@HAVE_PYTHON_TRUE@libguestfsmod_la_LDFLAGS = -avoid-version
+@HAVE_PYTHON_TRUE@libguestfsmod_la_LDFLAGS = -avoid-version -shared
 @HAVE_PYTHON_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_PYTHON_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 @HAVE_PYTHON_TRUE@	PYTHONPATH=$(builddir):$(builddir)/.libs \
 @HAVE_PYTHON_TRUE@	TMPDIR=$(top_builddir)
 
-@HAVE_PYTHON_TRUE@TESTS = run-bindtests run-python-tests
+@HAVE_PYTHON_TRUE@TESTS = run-bindtests $(am__append_1)
 all: all-am
 
 .SUFFIXES:
diff --git a/python/examples/Makefile.in b/python/examples/Makefile.in
index 27e69f9..39588a0 100644
--- a/python/examples/Makefile.in
+++ b/python/examples/Makefile.in
@@ -1325,12 +1325,12 @@ uninstall-man: uninstall-man3
 guestfs-python.3 $(top_builddir)/html/guestfs-python.3.html: stamp-guestfs-python.pod
 
 stamp-guestfs-python.pod: guestfs-python.pod create_disk.py inspect_vm.py
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-python.3 \
 	  --html $(top_builddir)/html/guestfs-python.3.html \
-	  --verbatim create_disk.py:@EXAMPLE1@ \
-	  --verbatim inspect_vm.py:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/create_disk.py:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/inspect_vm.py:@EXAMPLE2@ \
 	  $<
 	touch $@
 
diff --git a/rescue/Makefile.in b/rescue/Makefile.in
index 966f1e2..dfd99dd 100644
--- a/rescue/Makefile.in
+++ b/rescue/Makefile.in
@@ -1663,7 +1663,7 @@ appliance: force
 virt-rescue.1 $(top_builddir)/html/virt-rescue.1.html: stamp-virt-rescue.pod
 
 stamp-virt-rescue.pod: virt-rescue.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man virt-rescue.1 \
 	  --html $(top_builddir)/html/virt-rescue.1.html \
 	  $<
diff --git a/resize/Makefile.in b/resize/Makefile.in
index 83d0724..436dc43 100644
--- a/resize/Makefile.in
+++ b/resize/Makefile.in
@@ -1135,7 +1135,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-resize test.img \
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	TMPDIR=$(top_builddir)
 
-@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@TESTS = test-virt-resize.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@TESTS = test-virt-resize.sh
 all: all-am
 
 .SUFFIXES:
@@ -1543,7 +1543,7 @@ appliance: force
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@virt-resize.1 $(top_builddir)/html/virt-resize.1.html: stamp-virt-resize.pod
 
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@stamp-virt-resize.pod: virt-resize.pod
-@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	$(top_srcdir)/podwrapper.sh \
+@HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	$(top_builddir)/podwrapper.sh \
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	  --man virt-resize.1 \
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	  --html $(top_builddir)/html/virt-resize.1.html \
 @HAVE_OCAML_PCRE_TRUE@@HAVE_OCAML_TRUE@	  $<
diff --git a/ruby/examples/Makefile.in b/ruby/examples/Makefile.in
index af07a36..9c9ebb2 100644
--- a/ruby/examples/Makefile.in
+++ b/ruby/examples/Makefile.in
@@ -1325,12 +1325,12 @@ uninstall-man: uninstall-man3
 guestfs-ruby.3 $(top_builddir)/html/guestfs-ruby.3.html: stamp-guestfs-ruby.pod
 
 stamp-guestfs-ruby.pod: guestfs-ruby.pod create_disk.rb inspect_vm.rb
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs-ruby.3 \
 	  --html $(top_builddir)/html/guestfs-ruby.3.html \
-	  --verbatim create_disk.rb:@EXAMPLE1@ \
-	  --verbatim inspect_vm.rb:@EXAMPLE2@ \
+	  --verbatim $(srcdir)/create_disk.rb:@EXAMPLE1@ \
+	  --verbatim $(srcdir)/inspect_vm.rb:@EXAMPLE2@ \
 	  $<
 	touch $@
 
diff --git a/src/Makefile.in b/src/Makefile.in
index ae1903a..37f8f31 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -1245,7 +1245,7 @@ liberrnostring_la_CFLAGS =
 # Note that this scheme means the real library version will always be
 # 'libguestfs.so.0.$(MAX_PROC_NR).0'.
 libguestfs_la_LDFLAGS = -version-info $(MAX_PROC_NR):0:$(MAX_PROC_NR) \
-	$(VERSION_SCRIPT_FLAGS)libguestfs.syms
+	$(VERSION_SCRIPT_FLAGS)$(srcdir)/libguestfs.syms
 libguestfs_la_SOURCES = \
 	guestfs.c \
 	guestfs.h \
@@ -1918,14 +1918,14 @@ errnostring_gperf.c: errnostring_gperf.gperf
 
 @HAVE_RPCGEN_TRUE@guestfs_protocol.c: guestfs_protocol.x
 @HAVE_RPCGEN_TRUE@	rm -f $@-t $@-t2
-@HAVE_RPCGEN_TRUE@	$(RPCGEN) -c -o $@-t $<
+@HAVE_RPCGEN_TRUE@	$(RPCGEN) -c -o $@-t $(srcdir)/$<
 @HAVE_RPCGEN_TRUE@	sed 's,\.\./\.\./src/,,' < $@-t > $@-t2
 @HAVE_RPCGEN_TRUE@	rm $@-t
 @HAVE_RPCGEN_TRUE@	mv $@-t2 $@
 
 @HAVE_RPCGEN_TRUE@guestfs_protocol.h: guestfs_protocol.x
 @HAVE_RPCGEN_TRUE@	rm -f $@-t
-@HAVE_RPCGEN_TRUE@	$(RPCGEN) -h -o $@-t $<
+@HAVE_RPCGEN_TRUE@	$(RPCGEN) -h -o $@-t $(srcdir)/$<
 @HAVE_RPCGEN_TRUE@	mv $@-t $@
 
 guestfs.3 $(top_builddir)/html/guestfs.3.html: stamp-guestfs.pod
@@ -1934,13 +1934,13 @@ stamp-guestfs.pod: guestfs.pod \
 		guestfs-actions.pod \
 		guestfs-availability.pod \
 		guestfs-structs.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --section 3 \
 	  --man guestfs.3 \
 	  --html $(top_builddir)/html/guestfs.3.html \
-	  --insert guestfs-actions.pod:@ACTIONS@ \
-	  --insert guestfs-availability.pod:@AVAILABILITY@ \
-	  --insert guestfs-structs.pod:@STRUCTS@ \
+	  --insert $(srcdir)/guestfs-actions.pod:@ACTIONS@ \
+	  --insert $(srcdir)/guestfs-availability.pod:@AVAILABILITY@ \
+	  --insert $(srcdir)/guestfs-structs.pod:@STRUCTS@ \
 	  $<
 	touch $@
 
diff --git a/test-tool/Makefile.in b/test-tool/Makefile.in
index b627c01..bf96517 100644
--- a/test-tool/Makefile.in
+++ b/test-tool/Makefile.in
@@ -1549,7 +1549,7 @@ appliance: force
 	$(MAKE) -C $(top_builddir)/appliance
 
 libguestfs-test-tool.1: libguestfs-test-tool.pod
-	$(top_srcdir)/podwrapper.sh \
+	$(top_builddir)/podwrapper.sh \
 	  --man $@ \
 	  $<
 
diff --git a/tools/Makefile.in b/tools/Makefile.in
index 6e9f0df..0e2bd8f 100644
--- a/tools/Makefile.in
+++ b/tools/Makefile.in
@@ -1123,9 +1123,9 @@ CLEANFILES = test.img
 @HAVE_TOOLS_TRUE@	TMPDIR=$(top_builddir) \
 @HAVE_TOOLS_TRUE@	PERL5LIB=$(top_builddir)/perl/blib/lib:$(top_builddir)/perl/blib/arch
 
-@HAVE_TOOLS_TRUE@TESTS = test-virt-list-filesystems.sh \
-@HAVE_TOOLS_TRUE@	test-virt-make-fs.sh \
-@HAVE_TOOLS_TRUE@	test-virt-tar.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@TESTS = test-virt-list-filesystems.sh \
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@	test-virt-make-fs.sh \
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@	test-virt-tar.sh
 
 all: all-am
 
@@ -1521,12 +1521,12 @@ appliance: force
 	$(MAKE) -C $(top_builddir)/appliance
 
 @HAVE_TOOLS_TRUE@virt-%.1: virt-%
-@HAVE_TOOLS_TRUE@	$(top_srcdir)/podwrapper.sh \
+@HAVE_TOOLS_TRUE@	$(top_builddir)/podwrapper.sh \
 @HAVE_TOOLS_TRUE@	  --man $@ \
 @HAVE_TOOLS_TRUE@	  $<
 
 @HAVE_TOOLS_TRUE@$(top_builddir)/html/virt-%.1.html: virt-%
-@HAVE_TOOLS_TRUE@	$(top_srcdir)/podwrapper.sh \
+@HAVE_TOOLS_TRUE@	$(top_builddir)/podwrapper.sh \
 @HAVE_TOOLS_TRUE@	  --html $@ \
 @HAVE_TOOLS_TRUE@	  $<
 
-- 
