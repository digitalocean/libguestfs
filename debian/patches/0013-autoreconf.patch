From: Hilko Bengen <bengen@debian.org>
Date: Sat, 20 Aug 2011 20:43:22 +0200
Subject: autoreconf

---
 Makefile.in          |   50 +++++++-------
 aclocal.m4           |   14 ++--
 cat/Makefile.in      |    2 +-
 clone/Makefile.in    |    2 +-
 config.h.in          |    4 +-
 configure            |  186 +++++++++++++++++++++++++++++---------------------
 daemon/Makefile.in   |    4 +-
 df/Makefile.in       |    2 +-
 edit/Makefile.in     |    2 +-
 fuse/Makefile.in     |    2 +-
 images/Makefile.in   |    2 +-
 java/Makefile.in     |    5 +-
 ocaml/Makefile.in    |   19 +++---
 perl/Makefile.in     |    8 ++-
 python/Makefile.in   |    3 +-
 resize/Makefile.in   |    7 +-
 sparsify/Makefile.in |    8 +-
 tools/Makefile.in    |    6 +-
 18 files changed, 181 insertions(+), 145 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index 20f6faf..35f226f 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -71,7 +71,6 @@ DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(srcdir)/config.h.in \
 	$(srcdir)/libguestfs.pc.in $(srcdir)/podwrapper.sh.in \
 	$(srcdir)/run.in $(top_srcdir)/configure \
-	$(top_srcdir)/debian/changelog.in \
 	$(top_srcdir)/subdir-rules.mk ABOUT-NLS AUTHORS COPYING \
 	COPYING.LIB ChangeLog TODO build-aux/compile \
 	build-aux/config.guess build-aux/config.rpath \
@@ -79,30 +78,31 @@ DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
 	build-aux/ltmain.sh build-aux/missing
 @ENABLE_DAEMON_TRUE@am__append_1 = daemon
 @ENABLE_APPLIANCE_TRUE@am__append_2 = appliance
+@ENABLE_APPLIANCE_TRUE@am__append_3 = capitests caution regressions extratests
 
 # Language bindings.
-@HAVE_PERL_TRUE@am__append_3 = perl perl/examples
-@HAVE_OCAML_TRUE@am__append_4 = ocaml ocaml/examples
-@HAVE_PYTHON_TRUE@am__append_5 = python python/examples
-@HAVE_RUBY_TRUE@am__append_6 = ruby ruby/examples
-@HAVE_JAVA_TRUE@am__append_7 = java java/examples
-@HAVE_HASKELL_TRUE@am__append_8 = haskell
-@HAVE_PHP_TRUE@am__append_9 = php
-@HAVE_ERLANG_TRUE@am__append_10 = erlang erlang/examples
+@HAVE_PERL_TRUE@am__append_4 = perl perl/examples
+@HAVE_OCAML_TRUE@am__append_5 = ocaml ocaml/examples
+@HAVE_PYTHON_TRUE@am__append_6 = python python/examples
+@HAVE_RUBY_TRUE@am__append_7 = ruby ruby/examples
+@HAVE_JAVA_TRUE@am__append_8 = java java/examples
+@HAVE_HASKELL_TRUE@am__append_9 = haskell
+@HAVE_PHP_TRUE@am__append_10 = php
+@HAVE_ERLANG_TRUE@am__append_11 = erlang erlang/examples
 
 # virt-resize (new version) and virt-sparsify are written in OCaml.
-@HAVE_OCAML_TRUE@am__append_11 = resize sparsify
+@HAVE_OCAML_TRUE@am__append_12 = resize sparsify
 
 # Perl tools.
-@HAVE_TOOLS_TRUE@am__append_12 = tools
+@HAVE_TOOLS_TRUE@am__append_13 = tools
 
 # guestmount
 
 # virt-tools in shell.  This uses guestmount and virt-inspector.
-@HAVE_FUSE_TRUE@am__append_13 = fuse clone
+@HAVE_FUSE_TRUE@am__append_14 = fuse clone
 
 # po-docs must come after tools, inspector.
-@HAVE_PO4A_TRUE@am__append_14 = po-docs
+@HAVE_PO4A_TRUE@am__append_15 = po-docs
 subdir = .
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -224,7 +224,7 @@ am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
  configure.lineno config.status.lineno
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = config.h
-CONFIG_CLEAN_FILES = podwrapper.sh run debian/changelog libguestfs.pc
+CONFIG_CLEAN_FILES = podwrapper.sh run libguestfs.pc
 CONFIG_CLEAN_VPATH_FILES =
 AM_V_GEN = $(am__v_GEN_$(V))
 am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
@@ -272,10 +272,10 @@ AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
 ETAGS = etags
 CTAGS = ctags
 DIST_SUBDIRS = gnulib/lib images generator src examples po daemon \
-	appliance gnulib/tests capitests caution regressions \
-	extratests test-tool fish align cat df edit inspector rescue \
-	perl perl/examples ocaml ocaml/examples python python/examples \
-	ruby ruby/examples java java/examples haskell php erlang \
+	appliance gnulib/tests test-tool capitests caution regressions \
+	extratests fish align cat df edit inspector rescue perl \
+	perl/examples ocaml ocaml/examples python python/examples ruby \
+	ruby/examples java java/examples haskell php erlang \
 	erlang/examples csharp resize sparsify tools fuse clone \
 	po-docs
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
@@ -1323,12 +1323,12 @@ ACLOCAL_AMFLAGS = -I m4
 
 # Unconditional because nothing is built yet.
 SUBDIRS = gnulib/lib images generator src examples po $(am__append_1) \
-	$(am__append_2) gnulib/tests capitests caution regressions \
-	extratests test-tool fish align cat df edit inspector rescue \
-	$(am__append_3) $(am__append_4) $(am__append_5) \
-	$(am__append_6) $(am__append_7) $(am__append_8) \
-	$(am__append_9) $(am__append_10) csharp $(am__append_11) \
-	$(am__append_12) $(am__append_13) $(am__append_14)
+	$(am__append_2) gnulib/tests test-tool $(am__append_3) fish \
+	align cat df edit inspector rescue $(am__append_4) \
+	$(am__append_5) $(am__append_6) $(am__append_7) \
+	$(am__append_8) $(am__append_9) $(am__append_10) \
+	$(am__append_11) csharp $(am__append_12) $(am__append_13) \
+	$(am__append_14) $(am__append_15)
 EXTRA_DIST = \
 	$(generator_built) \
 	BUGS HACKING RELEASE-NOTES ROADMAP TODO \
@@ -1480,8 +1480,6 @@ podwrapper.sh: $(top_builddir)/config.status $(srcdir)/podwrapper.sh.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
 run: $(top_builddir)/config.status $(srcdir)/run.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
-debian/changelog: $(top_builddir)/config.status $(top_srcdir)/debian/changelog.in
-	cd $(top_builddir) && $(SHELL) ./config.status $@
 libguestfs.pc: $(top_builddir)/config.status $(srcdir)/libguestfs.pc.in
 	cd $(top_builddir) && $(SHELL) ./config.status $@
 
diff --git a/aclocal.m4 b/aclocal.m4
index 44c3f1c..01d9587 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -47,7 +47,8 @@ To do so, use the procedure documented by the package, typically `autoreconf'.])
 # ----------------------------------
 AC_DEFUN([PKG_PROG_PKG_CONFIG],
 [m4_pattern_forbid([^_?PKG_[A-Z_]+$])
-m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
+m4_pattern_allow([^PKG_CONFIG(_(PATH|LIBDIR|SYSROOT_DIR|ALLOW_SYSTEM_(CFLAGS|LIBS)))?$])
+m4_pattern_allow([^PKG_CONFIG_(DISABLE_UNINSTALLED|TOP_BUILD_DIR|DEBUG_SPEW)$])
 AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])
 AC_ARG_VAR([PKG_CONFIG_PATH], [directories to add to pkg-config's search path])
 AC_ARG_VAR([PKG_CONFIG_LIBDIR], [path overriding pkg-config's built-in search path])
@@ -93,7 +94,8 @@ m4_define([_PKG_CONFIG],
     pkg_cv_[]$1="$$1"
  elif test -n "$PKG_CONFIG"; then
     PKG_CHECK_EXISTS([$3],
-                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
+                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes ],
 		     [pkg_failed=yes])
  else
     pkg_failed=untried
@@ -141,9 +143,9 @@ if test $pkg_failed = yes; then
    	AC_MSG_RESULT([no])
         _PKG_SHORT_ERRORS_SUPPORTED
         if test $_pkg_short_errors_supported = yes; then
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "$2" 2>&1`
         else 
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "$2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
@@ -156,7 +158,7 @@ $$1_PKG_ERRORS
 Consider adjusting the PKG_CONFIG_PATH environment variable if you
 installed software in a non-standard prefix.
 
-_PKG_TEXT])
+_PKG_TEXT])[]dnl
         ])
 elif test $pkg_failed = untried; then
      	AC_MSG_RESULT([no])
@@ -167,7 +169,7 @@ path to pkg-config.
 
 _PKG_TEXT
 
-To get pkg-config, see <http://pkg-config.freedesktop.org/>.])
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.])[]dnl
         ])
 else
 	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
diff --git a/cat/Makefile.in b/cat/Makefile.in
index 6bcc62e..9f6c814 100644
--- a/cat/Makefile.in
+++ b/cat/Makefile.in
@@ -1378,7 +1378,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-cat.sh test-virt-filesystems.sh test-virt-ls.sh
 all: all-am
 
 .SUFFIXES:
diff --git a/clone/Makefile.in b/clone/Makefile.in
index 5c3f5b3..2fcacf4 100644
--- a/clone/Makefile.in
+++ b/clone/Makefile.in
@@ -1245,7 +1245,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-sysprep.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-sysprep.sh
 all: all-am
 
 .SUFFIXES:
diff --git a/config.h.in b/config.h.in
index dae6bce..1e5b162 100644
--- a/config.h.in
+++ b/config.h.in
@@ -889,10 +889,10 @@
 /* Define if the POSIX multithreading library has read/write locks. */
 #undef HAVE_PTHREAD_RWLOCK
 
-/* Define to 1 if you have the `PyCapsule_New' function. */
+/* Found PyCapsule_New in libpython */
 #undef HAVE_PYCAPSULE_NEW
 
-/* Define to 1 if you have the `PyString_AsString' function. */
+/* Found PyString_AsString in libpython */
 #undef HAVE_PYSTRING_ASSTRING
 
 /* Define to 1 if you have the `raise' function. */
diff --git a/configure b/configure
index 423a3e7..2b14d8b 100755
--- a/configure
+++ b/configure
@@ -45148,7 +45148,10 @@ else
   enable_install_daemon=no
 fi
 
-         if test "x$enable_install_daemon" = "xyes"; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: result: $enable_install_daemon" >&5
+$as_echo "$enable_install_daemon" >&6; }
+fi
+ if test "x$enable_install_daemon" = "xyes"; then
   INSTALL_DAEMON_TRUE=
   INSTALL_DAEMON_FALSE='#'
 else
@@ -45156,9 +45159,6 @@ else
   INSTALL_DAEMON_FALSE=
 fi
 
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: $enable_install_daemon" >&5
-$as_echo "$enable_install_daemon" >&6; }
-fi
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking if we should build the appliance" >&5
 $as_echo_n "checking if we should build the appliance... " >&6; }
@@ -45180,8 +45180,7 @@ fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $enable_appliance" >&5
 $as_echo "$enable_appliance" >&6; }
 
-if test "x$enable_appliance" = "xyes"; then
-        # Extract the first word of "febootstrap", so it can be a program name with args.
+# Extract the first word of "febootstrap", so it can be a program name with args.
 set dummy febootstrap; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
@@ -45219,12 +45218,8 @@ $as_echo "no" >&6; }
 fi
 
 
-    test "x$FEBOOTSTRAP" = "xno" &&
-        as_fn_error $? "febootstrap must be installed" "$LINENO" 5
-        $FEBOOTSTRAP --version >&5 2>&1 ||
-        as_fn_error $? "febootstrap >= 3.0 must be installed, your version is too old" "$LINENO" 5
 
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking if user requested febootstrap --yum-config option" >&5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if user requested febootstrap --yum-config option" >&5
 $as_echo_n "checking if user requested febootstrap --yum-config option... " >&6; }
 
 # Check whether --with-febootstrap-yum-config was given.
@@ -45234,26 +45229,32 @@ else
   FEBOOTSTRAP_YUM_CONFIG=no
 fi
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $FEBOOTSTRAP_YUM_CONFIG" >&5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $FEBOOTSTRAP_YUM_CONFIG" >&5
 $as_echo "$FEBOOTSTRAP_YUM_CONFIG" >&6; }
 
 
-                            { $as_echo "$as_me:${as_lineno-$LINENO}: checking which Linux distro for package names" >&5
+if test "x$enable_appliance" = "xyes"; then
+    test "x$FEBOOTSTRAP" = "xno" &&
+        as_fn_error $? "febootstrap must be installed" "$LINENO" 5
+        $FEBOOTSTRAP --version >&5 2>&1 ||
+        as_fn_error $? "febootstrap >= 3.0 must be installed, your version is too old" "$LINENO" 5
+fi
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking which Linux distro for package names" >&5
 $as_echo_n "checking which Linux distro for package names... " >&6; }
-    DISTRO=REDHAT
-    if test -f /etc/debian_version; then
-        DISTRO=DEBIAN
-	if grep -q 'DISTRIB_ID=Ubuntu' /etc/lsb-release 2>&5; then
-            DISTRO=UBUNTU
-	fi
-    fi
-    if test -f /etc/arch-release; then
-        DISTRO=ARCHLINUX
+DISTRO=REDHAT
+if test -f /etc/debian_version; then
+    DISTRO=DEBIAN
+    if grep -q 'DISTRIB_ID=Ubuntu' /etc/lsb-release 2>&5; then
+        DISTRO=UBUNTU
     fi
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DISTRO" >&5
+fi
+if test -f /etc/arch-release; then
+    DISTRO=ARCHLINUX
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $DISTRO" >&5
 $as_echo "$DISTRO" >&6; }
 
-fi
 
 # Extract the first word of "rpcgen", so it can be a program name with args.
 set dummy rpcgen; ac_word=$2
@@ -45412,6 +45413,7 @@ fi
 
 
 
+
 if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
 	if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
@@ -45540,6 +45542,7 @@ if test -n "$AUGEAS_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_AUGEAS_CFLAGS=`$PKG_CONFIG --cflags "augeas" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -45556,6 +45559,7 @@ if test -n "$AUGEAS_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_AUGEAS_LIBS=`$PKG_CONFIG --libs "augeas" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -45575,9 +45579,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        AUGEAS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "augeas" 2>&1`
+	        AUGEAS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "augeas" 2>&1`
         else
-	        AUGEAS_PKG_ERRORS=`$PKG_CONFIG --print-errors "augeas" 2>&1`
+	        AUGEAS_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "augeas" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$AUGEAS_PKG_ERRORS" >&5
@@ -48249,6 +48253,7 @@ if test -n "$PCRE_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_PCRE_CFLAGS=`$PKG_CONFIG --cflags "libpcre" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48265,6 +48270,7 @@ if test -n "$PCRE_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_PCRE_LIBS=`$PKG_CONFIG --libs "libpcre" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48284,9 +48290,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        PCRE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libpcre" 2>&1`
+	        PCRE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libpcre" 2>&1`
         else
-	        PCRE_PKG_ERRORS=`$PKG_CONFIG --print-errors "libpcre" 2>&1`
+	        PCRE_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libpcre" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$PCRE_PKG_ERRORS" >&5
@@ -48301,7 +48307,6 @@ installed software in a non-standard prefix.
 Alternatively, you may set the environment variables PCRE_CFLAGS
 and PCRE_LIBS to avoid the need to call pkg-config.
 See the pkg-config man page for more details." "$LINENO" 5
-
 elif test $pkg_failed = untried; then
      	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
@@ -48317,7 +48322,6 @@ See the pkg-config man page for more details.
 
 To get pkg-config, see <http://pkg-config.freedesktop.org/>.
 See \`config.log' for more details" "$LINENO" 5; }
-
 else
 	PCRE_CFLAGS=$pkg_cv_PCRE_CFLAGS
 	PCRE_LIBS=$pkg_cv_PCRE_LIBS
@@ -48396,6 +48400,7 @@ if test -n "$LIBVIRT_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBVIRT_CFLAGS=`$PKG_CONFIG --cflags "libvirt" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48412,6 +48417,7 @@ if test -n "$LIBVIRT_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBVIRT_LIBS=`$PKG_CONFIG --libs "libvirt" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48431,9 +48437,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libvirt" 2>&1`
+	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libvirt" 2>&1`
         else
-	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --print-errors "libvirt" 2>&1`
+	        LIBVIRT_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libvirt" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBVIRT_PKG_ERRORS" >&5
@@ -48481,6 +48487,7 @@ if test -n "$LIBXML2_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_CFLAGS=`$PKG_CONFIG --cflags "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48497,6 +48504,7 @@ if test -n "$LIBXML2_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBXML2_LIBS=`$PKG_CONFIG --libs "libxml-2.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48516,9 +48524,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libxml-2.0" 2>&1`
         else
-	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors "libxml-2.0" 2>&1`
+	        LIBXML2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libxml-2.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBXML2_PKG_ERRORS" >&5
@@ -48566,6 +48574,7 @@ if test -n "$LIBCONFIG_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBCONFIG_CFLAGS=`$PKG_CONFIG --cflags "libconfig" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48582,6 +48591,7 @@ if test -n "$LIBCONFIG_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_LIBCONFIG_LIBS=`$PKG_CONFIG --libs "libconfig" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48601,9 +48611,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libconfig" 2>&1`
+	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libconfig" 2>&1`
         else
-	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --print-errors "libconfig" 2>&1`
+	        LIBCONFIG_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libconfig" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LIBCONFIG_PKG_ERRORS" >&5
@@ -48651,6 +48661,7 @@ if test -n "$HIVEX_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_HIVEX_CFLAGS=`$PKG_CONFIG --cflags "hivex" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48667,6 +48678,7 @@ if test -n "$HIVEX_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_HIVEX_LIBS=`$PKG_CONFIG --libs "hivex" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48686,9 +48698,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "hivex" 2>&1`
+	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "hivex" 2>&1`
         else
-	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --print-errors "hivex" 2>&1`
+	        HIVEX_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "hivex" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$HIVEX_PKG_ERRORS" >&5
@@ -48744,6 +48756,7 @@ if test -n "$FUSE_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_FUSE_CFLAGS=`$PKG_CONFIG --cflags "fuse" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48760,6 +48773,7 @@ if test -n "$FUSE_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_FUSE_LIBS=`$PKG_CONFIG --libs "fuse" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -48779,9 +48793,9 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        FUSE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "fuse" 2>&1`
+	        FUSE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "fuse" 2>&1`
         else
-	        FUSE_PKG_ERRORS=`$PKG_CONFIG --print-errors "fuse" 2>&1`
+	        FUSE_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "fuse" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$FUSE_PKG_ERRORS" >&5
@@ -50019,19 +50033,16 @@ $as_echo "$PYTHON_INSTALLDIR" >&6; }
             fi
 
                         old_LIBS="$LIBS"
-            if test "x$PYTHON_VERSION_MAJOR" = "x3"; then
-                                LIBPYTHON="python${PYTHON_VERSION}mu"
-            else
-                LIBPYTHON="python$PYTHON_VERSION"
-            fi
-            as_ac_Lib=`$as_echo "ac_cv_lib_$LIBPYTHON''_PyList_Size" | $as_tr_sh`
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for PyList_Size in -l$LIBPYTHON" >&5
-$as_echo_n "checking for PyList_Size in -l$LIBPYTHON... " >&6; }
-if eval \${$as_ac_Lib+:} false; then :
+
+            PYTHON_BLDLIBRARY=`$PYTHON -c "import distutils.sysconfig; \
+                                           print (distutils.sysconfig.get_config_var('BLDLIBRARY'))"`
+            { $as_echo "$as_me:${as_lineno-$LINENO}: checking for PyCapsule_New in -lc" >&5
+$as_echo_n "checking for PyCapsule_New in -lc... " >&6; }
+if ${ac_cv_lib_c_PyCapsule_New+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-l$LIBPYTHON  $LIBS"
+LIBS="-lc $PYTHON_BLDLIBRARY $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -50041,54 +50052,74 @@ cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 #ifdef __cplusplus
 extern "C"
 #endif
-char PyList_Size ();
+char PyCapsule_New ();
 int
 main ()
 {
-return PyList_Size ();
+return PyCapsule_New ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  eval "$as_ac_Lib=yes"
+  ac_cv_lib_c_PyCapsule_New=yes
 else
-  eval "$as_ac_Lib=no"
+  ac_cv_lib_c_PyCapsule_New=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-eval ac_res=\$$as_ac_Lib
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-if eval test \"x\$"$as_ac_Lib"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_LIB$LIBPYTHON" | $as_tr_cpp` 1
-_ACEOF
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_PyCapsule_New" >&5
+$as_echo "$ac_cv_lib_c_PyCapsule_New" >&6; }
+if test "x$ac_cv_lib_c_PyCapsule_New" = xyes; then :
 
-  LIBS="-l$LIBPYTHON $LIBS"
+$as_echo "#define HAVE_PYCAPSULE_NEW 1" >>confdefs.h
 
-else
-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error $? "$LIBPYTHON is not installed
-See \`config.log' for more details" "$LINENO" 5; }
 fi
 
+            { $as_echo "$as_me:${as_lineno-$LINENO}: checking for PyString_AsString in -lc" >&5
+$as_echo_n "checking for PyString_AsString in -lc... " >&6; }
+if ${ac_cv_lib_c_PyString_AsString+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-lc $PYTHON_BLDLIBRARY $LIBS"
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-            for ac_func in PyCapsule_New \
-                            PyString_AsString
-do :
-  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
-ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char PyString_AsString ();
+int
+main ()
+{
+return PyString_AsString ();
+  ;
+  return 0;
+}
 _ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_lib_c_PyString_AsString=yes
+else
+  ac_cv_lib_c_PyString_AsString=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_PyString_AsString" >&5
+$as_echo "$ac_cv_lib_c_PyString_AsString" >&6; }
+if test "x$ac_cv_lib_c_PyString_AsString" = xyes; then :
+
+$as_echo "#define HAVE_PYSTRING_ASSTRING 1" >>confdefs.h
 
 fi
-done
+
 
             LIBS="$old_LIBS"
         fi
@@ -51202,7 +51233,7 @@ ac_config_files="$ac_config_files podwrapper.sh"
 
 ac_config_files="$ac_config_files run"
 
-ac_config_files="$ac_config_files Makefile align/Makefile appliance/Makefile capitests/Makefile cat/Makefile caution/Makefile clone/Makefile csharp/Makefile daemon/Makefile debian/changelog df/Makefile edit/Makefile erlang/Makefile erlang/examples/Makefile examples/Makefile extratests/Makefile fish/Makefile fuse/Makefile generator/Makefile gnulib/lib/Makefile gnulib/tests/Makefile haskell/Makefile images/Makefile inspector/Makefile java/Makefile java/examples/Makefile libguestfs.pc ocaml/META ocaml/Makefile ocaml/examples/Makefile perl/Makefile perl/Makefile.PL perl/examples/Makefile php/Makefile po-docs/Makefile po-docs/ja/Makefile po-docs/uk/Makefile po/Makefile.in python/Makefile python/examples/Makefile regressions/Makefile rescue/Makefile resize/Makefile ruby/Makefile ruby/Rakefile ruby/examples/Makefile sparsify/Makefile src/Makefile test-tool/Makefile tools/Makefile"
+ac_config_files="$ac_config_files Makefile align/Makefile appliance/Makefile capitests/Makefile cat/Makefile caution/Makefile clone/Makefile csharp/Makefile daemon/Makefile df/Makefile edit/Makefile erlang/Makefile erlang/examples/Makefile examples/Makefile extratests/Makefile fish/Makefile fuse/Makefile generator/Makefile gnulib/lib/Makefile gnulib/tests/Makefile haskell/Makefile images/Makefile inspector/Makefile java/Makefile java/examples/Makefile libguestfs.pc ocaml/META ocaml/Makefile ocaml/examples/Makefile perl/Makefile perl/Makefile.PL perl/examples/Makefile php/Makefile po-docs/Makefile po-docs/ja/Makefile po-docs/uk/Makefile po/Makefile.in python/Makefile python/examples/Makefile regressions/Makefile rescue/Makefile resize/Makefile ruby/Makefile ruby/Rakefile ruby/examples/Makefile sparsify/Makefile src/Makefile test-tool/Makefile tools/Makefile"
 
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
@@ -52416,7 +52447,6 @@ do
     "clone/Makefile") CONFIG_FILES="$CONFIG_FILES clone/Makefile" ;;
     "csharp/Makefile") CONFIG_FILES="$CONFIG_FILES csharp/Makefile" ;;
     "daemon/Makefile") CONFIG_FILES="$CONFIG_FILES daemon/Makefile" ;;
-    "debian/changelog") CONFIG_FILES="$CONFIG_FILES debian/changelog" ;;
     "df/Makefile") CONFIG_FILES="$CONFIG_FILES df/Makefile" ;;
     "edit/Makefile") CONFIG_FILES="$CONFIG_FILES edit/Makefile" ;;
     "erlang/Makefile") CONFIG_FILES="$CONFIG_FILES erlang/Makefile" ;;
diff --git a/daemon/Makefile.in b/daemon/Makefile.in
index 1729c71..bb3c501 100644
--- a/daemon/Makefile.in
+++ b/daemon/Makefile.in
@@ -3112,10 +3112,10 @@ $(top_builddir)/daemon/guestfsd: force
 appliance: force
 	$(MAKE) -C $(top_builddir)/appliance
 
-guestfs_protocol.c: $(libsrcdir)/guestfs_protocol.c
+guestfs_protocol.c: $(srcdir)/guestfs_protocol.c
 	rm -f $@
 	ln $< $@
-guestfs_protocol.h: $(libsrcdir)/guestfs_protocol.h
+guestfs_protocol.h: $(srcdir)/guestfs_protocol.h
 	rm -f $@
 	ln $< $@
 $(libsrcdir)/guestfs_protocol.c: force
diff --git a/df/Makefile.in b/df/Makefile.in
index 5295978..65af300 100644
--- a/df/Makefile.in
+++ b/df/Makefile.in
@@ -1318,7 +1318,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-df.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-df.sh
 all: all-am
 
 .SUFFIXES:
diff --git a/edit/Makefile.in b/edit/Makefile.in
index 2ca79f7..fee9e78 100644
--- a/edit/Makefile.in
+++ b/edit/Makefile.in
@@ -1307,7 +1307,7 @@ TESTS_ENVIRONMENT = \
 	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 	TMPDIR=$(top_builddir)
 
-TESTS = test-virt-edit.sh
+@ENABLE_APPLIANCE_TRUE@TESTS = test-virt-edit.sh
 all: all-am
 
 .SUFFIXES:
diff --git a/fuse/Makefile.in b/fuse/Makefile.in
index 3653843..c02863b 100644
--- a/fuse/Makefile.in
+++ b/fuse/Makefile.in
@@ -1314,7 +1314,7 @@ CLEANFILES = stamp-guestmount.pod
 @HAVE_FUSE_TRUE@noinst_DATA = $(top_builddir)/html/guestmount.1.html
 
 # Tests.
-@HAVE_FUSE_TRUE@TESTS = test-fuse.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_FUSE_TRUE@TESTS = test-fuse.sh
 @HAVE_FUSE_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_FUSE_TRUE@	top_builddir=..
 
diff --git a/images/Makefile.in b/images/Makefile.in
index b056a5d..c66b982 100644
--- a/images/Makefile.in
+++ b/images/Makefile.in
@@ -1233,7 +1233,7 @@ noinst_DATA = test.iso
 
 # This is 'check_DATA' because we don't need it until 'make check'
 # time and we need the tools we have built in order to make it.
-check_DATA = debian.img fedora.img ubuntu.img windows.img
+@ENABLE_APPLIANCE_TRUE@check_DATA = debian.img fedora.img ubuntu.img windows.img
 CLEANFILES = \
 	test.iso test.sqsh \
 	100kallzeroes 100kallnewlines 100kallspaces 100krandom 10klines \
diff --git a/java/Makefile.in b/java/Makefile.in
index 0437ee7..e8bc684 100644
--- a/java/Makefile.in
+++ b/java/Makefile.in
@@ -92,6 +92,7 @@ build_triplet = @build@
 host_triplet = @host@
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
 	$(srcdir)/Makefile.inc $(top_srcdir)/subdir-rules.mk
+@ENABLE_APPLIANCE_TRUE@@HAVE_JAVA_TRUE@am__append_1 = run-java-tests
 subdir = java
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1264,7 +1265,7 @@ htmldir = @htmldir@
 includedir = @includedir@
 infodir = @infodir@
 install_sh = @install_sh@
-libdir = @libdir@
+libdir = ${prefix}/lib/jni
 libexecdir = @libexecdir@
 lispdir = @lispdir@
 localedir = @localedir@
@@ -1353,7 +1354,7 @@ CLEANFILES = doc-stamp $(builddir)/com/redhat/et/libguestfs/*.class com_redhat_e
 @HAVE_JAVA_TRUE@noinst_SCRIPTS = doc-stamp
 
 # Tests (not comprehensive).
-@HAVE_JAVA_TRUE@TESTS = run-bindtests run-java-tests
+@HAVE_JAVA_TRUE@TESTS = run-bindtests $(am__append_1)
 @HAVE_JAVA_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_JAVA_TRUE@	JAVA=$(JAVA) \
 @HAVE_JAVA_TRUE@	CLASSPATH=.:t:libguestfs-$(VERSION).jar \
diff --git a/ocaml/Makefile.in b/ocaml/Makefile.in
index b0aef84..6d86177 100644
--- a/ocaml/Makefile.in
+++ b/ocaml/Makefile.in
@@ -71,7 +71,11 @@ DIST_COMMON = $(srcdir)/.depend $(srcdir)/META.in \
 	$(srcdir)/Makefile.am $(srcdir)/Makefile.in \
 	$(top_srcdir)/subdir-rules.mk
 @HAVE_OCAMLDOC_TRUE@@HAVE_OCAML_TRUE@am__append_1 = html/index.html
-@HAVE_OCAML_TRUE@am__append_2 = $(noinst_DATA)
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@am__append_2 = t/guestfs_010_basic \
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@	t/guestfs_070_threads \
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@	t/guestfs_400_progress
+
+@HAVE_OCAML_TRUE@am__append_3 = $(noinst_DATA)
 subdir = ocaml
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1218,7 +1222,7 @@ EXTRA_DIST = \
 	t/*.ml
 
 CLEANFILES = *.cmi *.cmo *.cmx *.cma *.cmxa *.o *.a *.so t/*.cmi \
-	t/*.cmo t/*.cmx t/*.o t/*.a t/*.so $(am__append_2)
+	t/*.cmo t/*.cmx t/*.o t/*.a t/*.so $(am__append_3)
 AM_CPPFLAGS = -I$(top_builddir) -I$(OCAMLLIB) -I$(top_srcdir)/ocaml \
   -I$(top_srcdir)/src -I$(top_builddir)/src \
   $(WARN_CFLAGS) $(WERROR_CFLAGS)
@@ -1238,14 +1242,9 @@ AM_CPPFLAGS = -I$(top_builddir) -I$(OCAMLLIB) -I$(top_srcdir)/ocaml \
 @HAVE_OCAML_TRUE@	TMPDIR=$(top_builddir) \
 @HAVE_OCAML_TRUE@	$(VG)
 
-@HAVE_OCAML_TRUE@TESTS = run-bindtests \
-@HAVE_OCAML_TRUE@	t/guestfs_005_load \
-@HAVE_OCAML_TRUE@	t/guestfs_010_basic \
-@HAVE_OCAML_TRUE@	t/guestfs_070_threads \
-@HAVE_OCAML_TRUE@	t/guestfs_080_optargs \
-@HAVE_OCAML_TRUE@	t/guestfs_400_events \
-@HAVE_OCAML_TRUE@	t/guestfs_400_progress
-
+@HAVE_OCAML_TRUE@TESTS = run-bindtests t/guestfs_005_load \
+@HAVE_OCAML_TRUE@	t/guestfs_080_optargs t/guestfs_400_events \
+@HAVE_OCAML_TRUE@	$(am__append_2)
 @HAVE_OCAML_TRUE@SUFFIXES = .cmo .cmi .cmx .ml .mli .mll .mly
 all: all-am
 
diff --git a/perl/Makefile.in b/perl/Makefile.in
index 95a8f68..6d477fa 100644
--- a/perl/Makefile.in
+++ b/perl/Makefile.in
@@ -68,6 +68,8 @@ build_triplet = @build@
 host_triplet = @host@
 DIST_COMMON = README $(srcdir)/Makefile.PL.in $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(top_srcdir)/subdir-rules.mk
+@ENABLE_APPLIANCE_TRUE@@HAVE_PERL_TRUE@am__append_1 = appliance
+@ENABLE_APPLIANCE_TRUE@@HAVE_PERL_TRUE@am__append_2 = run-perl-tests
 subdir = perl
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1214,7 +1216,8 @@ EXTRA_DIST = \
 	t/*.t \
 	typemap
 
-@HAVE_PERL_TRUE@TESTS = run-bindtests run-perl-tests
+@HAVE_PERL_TRUE@TESTS = run-bindtests $(am__append_2)
+@HAVE_PERL_TRUE@test_prereq = src_deps all test_images $(am__append_1)
 @HAVE_PERL_TRUE@TESTS_ENVIRONMENT = \
 @HAVE_PERL_TRUE@	LD_LIBRARY_PATH=$(top_builddir)/src/.libs \
 @HAVE_PERL_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
@@ -1539,12 +1542,13 @@ appliance: force
 @HAVE_PERL_TRUE@test_images:
 @HAVE_PERL_TRUE@	$(MAKE) -C $(top_builddir)/images
 
-@HAVE_PERL_TRUE@$(TESTS): src_deps all appliance test_images
+@HAVE_PERL_TRUE@$(TESTS): $(test_prereq)
 
 @HAVE_PERL_TRUE@all: Makefile-pl src_deps
 @HAVE_PERL_TRUE@	$(MAKE) -f Makefile-pl
 
 @HAVE_PERL_TRUE@Makefile-pl: Makefile.PL
+@HAVE_PERL_TRUE@	-[ $(srcdir) != $(builddir) ] && cp -rsu $(abs_srcdir)/. $(builddir)/.
 @HAVE_PERL_TRUE@	perl Makefile.PL INSTALLDIRS=$(INSTALLDIRS) PREFIX=$(prefix)
 
 # No!  Otherwise it is deleted before the clean-local rule runs.
diff --git a/python/Makefile.in b/python/Makefile.in
index 7db00ab..8aa691b 100644
--- a/python/Makefile.in
+++ b/python/Makefile.in
@@ -70,6 +70,7 @@ build_triplet = @build@
 host_triplet = @host@
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
 	$(top_srcdir)/subdir-rules.mk
+@ENABLE_APPLIANCE_TRUE@@HAVE_PYTHON_TRUE@am__append_1 = run-python-tests
 subdir = python
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1287,7 +1288,7 @@ EXTRA_DIST = \
 @HAVE_PYTHON_TRUE@	TMPDIR=$(top_builddir) \
 @HAVE_PYTHON_TRUE@	PYTHON=$(PYTHON)
 
-@HAVE_PYTHON_TRUE@TESTS = run-bindtests run-python-tests
+@HAVE_PYTHON_TRUE@TESTS = run-bindtests $(am__append_1)
 all: all-am
 
 .SUFFIXES:
diff --git a/resize/Makefile.in b/resize/Makefile.in
index 069f76e..5a8a828 100644
--- a/resize/Makefile.in
+++ b/resize/Makefile.in
@@ -72,6 +72,7 @@ DIST_COMMON = $(srcdir)/.depend $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(top_srcdir)/subdir-rules.mk
 SOURCES =
 @HAVE_OCAML_TRUE@am__append_1 = stamp-virt-resize.pod
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@am__append_2 = test-virt-resize.sh
 subdir = resize
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/00gnulib.m4 \
@@ -1247,7 +1248,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-resize test.img \
 
 # Note this list must be in dependency order.
 @HAVE_OCAML_TRUE@OBJECTS = \
-@HAVE_OCAML_TRUE@	../fish/guestfish-progress.o \
+@HAVE_OCAML_TRUE@	$(top_builddir)/fish/guestfish-progress.o \
 @HAVE_OCAML_TRUE@	progress_c.o \
 @HAVE_OCAML_TRUE@	utils.cmx \
 @HAVE_OCAML_TRUE@	progress.cmx \
@@ -1264,7 +1265,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-resize test.img \
 
 # automake will decide we don't need C support in this file.  Really
 # we do, so we have to provide it ourselves.
-@HAVE_OCAML_TRUE@DEFAULT_INCLUDES = -I. -I$(top_builddir) -I$(shell $(OCAMLC) -where) -I../fish
+@HAVE_OCAML_TRUE@DEFAULT_INCLUDES = -I. -I$(top_builddir) -I$(shell $(OCAMLC) -where) -I$(top_srcdir)/fish
 
 # Manual pages and HTML files for the website.
 @HAVE_OCAML_TRUE@man_MANS = virt-resize.1
@@ -1279,7 +1280,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-resize test.img \
 @HAVE_OCAML_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 @HAVE_OCAML_TRUE@	TMPDIR=$(top_builddir)
 
-@HAVE_OCAML_TRUE@TESTS = test-virt-resize.sh utils_tests
+@HAVE_OCAML_TRUE@TESTS = utils_tests $(am__append_2)
 all: all-am
 
 .SUFFIXES:
diff --git a/sparsify/Makefile.in b/sparsify/Makefile.in
index 422291e..e7fda17 100644
--- a/sparsify/Makefile.in
+++ b/sparsify/Makefile.in
@@ -1246,7 +1246,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-sparsify test.img \
 
 # Note this list must be in dependency order.
 @HAVE_OCAML_TRUE@OBJECTS = \
-@HAVE_OCAML_TRUE@	../fish/guestfish-progress.o \
+@HAVE_OCAML_TRUE@	$(top_builddir)/fish/guestfish-progress.o \
 @HAVE_OCAML_TRUE@	progress_c.o \
 @HAVE_OCAML_TRUE@	utils.cmx \
 @HAVE_OCAML_TRUE@	progress.cmx \
@@ -1257,13 +1257,13 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-sparsify test.img \
 # -I $(top_builddir)/src/.libs is a hack which forces corresponding -L
 # option to be passed to gcc, so we don't try linking against an
 # installed copy of libguestfs.
-@HAVE_OCAML_TRUE@OCAMLPACKAGES = -package unix -I $(top_builddir)/src/.libs -I ../ocaml
+@HAVE_OCAML_TRUE@OCAMLPACKAGES = -package unix -I $(top_builddir)/src/.libs -I $(top_builddir)/ocaml
 @HAVE_OCAML_TRUE@OCAMLCFLAGS = -g -warn-error CDEFLMPSUVYZX $(OCAMLPACKAGES)
 @HAVE_OCAML_TRUE@OCAMLOPTFLAGS = $(OCAMLCFLAGS)
 
 # automake will decide we don't need C support in this file.  Really
 # we do, so we have to provide it ourselves.
-@HAVE_OCAML_TRUE@DEFAULT_INCLUDES = -I. -I$(top_builddir) -I$(shell $(OCAMLC) -where) -I../fish
+@HAVE_OCAML_TRUE@DEFAULT_INCLUDES = -I. -I$(top_builddir) -I$(shell $(OCAMLC) -where) -I$(top_srcdir)/fish
 
 # Manual pages and HTML files for the website.
 @HAVE_OCAML_TRUE@man_MANS = virt-sparsify.1
@@ -1277,7 +1277,7 @@ CLEANFILES = *~ *.cmi *.cmo *.cmx *.cmxa *.o virt-sparsify test.img \
 @HAVE_OCAML_TRUE@	LIBGUESTFS_PATH=$(top_builddir)/appliance \
 @HAVE_OCAML_TRUE@	TMPDIR=$(top_builddir)
 
-@HAVE_OCAML_TRUE@TESTS = test-virt-sparsify.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_OCAML_TRUE@TESTS = test-virt-sparsify.sh
 all: all-am
 
 .SUFFIXES:
diff --git a/tools/Makefile.in b/tools/Makefile.in
index 47fd69f..6f5171a 100644
--- a/tools/Makefile.in
+++ b/tools/Makefile.in
@@ -1257,9 +1257,9 @@ CLEANFILES = test.img
 @HAVE_TOOLS_TRUE@	TMPDIR=$(top_builddir) \
 @HAVE_TOOLS_TRUE@	PERL5LIB=$(top_builddir)/perl/blib/lib:$(top_builddir)/perl/blib/arch
 
-@HAVE_TOOLS_TRUE@TESTS = test-virt-list-filesystems.sh \
-@HAVE_TOOLS_TRUE@	test-virt-make-fs.sh \
-@HAVE_TOOLS_TRUE@	test-virt-tar.sh
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@TESTS = test-virt-list-filesystems.sh \
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@	test-virt-make-fs.sh \
+@ENABLE_APPLIANCE_TRUE@@HAVE_TOOLS_TRUE@	test-virt-tar.sh
 
 all: all-am
 
-- 
