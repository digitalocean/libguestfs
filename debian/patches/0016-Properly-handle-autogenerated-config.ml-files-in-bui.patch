From: Hilko Bengen <bengen@debian.org>
Date: Mon, 23 Dec 2019 12:46:43 +0100
Subject: Properly handle autogenerated *config.ml files in builddir

---
 common/mlstdutils/Makefile.am | 2 +-
 daemon/Makefile.am            | 2 +-
 ocaml-dep.sh.in               | 2 +-
 subdir-rules.mk               | 4 ++++
 v2v/Makefile.am               | 2 +-
 5 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/common/mlstdutils/Makefile.am b/common/mlstdutils/Makefile.am
index ba11c11..9b8e0bd 100644
--- a/common/mlstdutils/Makefile.am
+++ b/common/mlstdutils/Makefile.am
@@ -141,7 +141,7 @@ check-valgrind:
 	$(MAKE) VG="@VG@" check
 
 # OCaml dependencies.
-.depend: $(srcdir)/*.mli $(srcdir)/*.ml
+.depend: $(srcdir)/*.mli $(srcdir)/*.ml $(builddir)/guestfs_config.ml
 	$(top_builddir)/ocaml-dep.sh $^
 -include .depend
 
diff --git a/daemon/Makefile.am b/daemon/Makefile.am
index b755d3c..ba0c771 100644
--- a/daemon/Makefile.am
+++ b/daemon/Makefile.am
@@ -379,7 +379,7 @@ camldaemon.o: $(OBJECTS)
 	    $(OBJECTS)
 
 # OCaml dependencies.
-.depend: $(srcdir)/*.mli $(srcdir)/*.ml
+.depend: $(srcdir)/*.mli $(srcdir)/*.ml $(builddir)/daemon_config.ml
 	$(top_builddir)/ocaml-dep.sh $^
 -include .depend
 
diff --git a/ocaml-dep.sh.in b/ocaml-dep.sh.in
index 9de8497..58d6254 100755
--- a/ocaml-dep.sh.in
+++ b/ocaml-dep.sh.in
@@ -74,7 +74,7 @@ echo >> $output-t
     | sed \
           -e "s,@abs_top_srcdir@/${subdir},.,g" \
           -e "s,\B${srcdir_re}/\\([^ ]*[.]\\)\\(cm[^ ]*\\|o\\),\\1\\2,g" \
-          -e "s,\B${srcdir_re}/\\([^ /]*_config[.]ml\\),\\1,g" \
+          -e "s,\B${srcdir_re}/\\([^ /]*config[.]ml\\),\\1,g" \
           -e "s,@abs_top_srcdir@/\\([^ ]*[.]\\)\\(cm[^ ]*\\|o\\),${top_builddir}/\\1\\2,g" \
           -e 's,\(^\| \)./,\1,g' \
     >> $output-t
diff --git a/subdir-rules.mk b/subdir-rules.mk
index 3a20cb1..5dbacb7 100644
--- a/subdir-rules.mk
+++ b/subdir-rules.mk
@@ -83,9 +83,13 @@ guestfs_am_v_jar_0 = @echo "  JAR     " $@;
 	$(guestfs_am_v_ocamlcmi)$(OCAMLFIND) ocamlc $(OCAMLFLAGS) $(OCAMLPACKAGES) -c $< -o $@
 %.cmo: $(srcdir)/%.ml
 	$(guestfs_am_v_ocamlc)$(OCAMLFIND) ocamlc $(OCAMLFLAGS) $(OCAMLPACKAGES) -c $< -o $@
+%.cmo: $(builddir)/%.ml
+	$(guestfs_am_v_ocamlc)$(OCAMLFIND) ocamlc $(OCAMLFLAGS) $(OCAMLPACKAGES) -c $< -o $@
 if HAVE_OCAMLOPT
 %.cmx: $(srcdir)/%.ml
 	$(guestfs_am_v_ocamlopt)$(OCAMLFIND) ocamlopt $(OCAMLFLAGS) $(OCAMLPACKAGES) -c $< -o $@
+%.cmx: $(builddir)/%.ml
+	$(guestfs_am_v_ocamlopt)$(OCAMLFIND) ocamlopt $(OCAMLFLAGS) $(OCAMLPACKAGES) -c $< -o $@
 endif
 
 # Test shell scripts should use '$TEST_FUNCTIONS' to get a predefined
diff --git a/v2v/Makefile.am b/v2v/Makefile.am
index bb0a57f..2e98809 100644
--- a/v2v/Makefile.am
+++ b/v2v/Makefile.am
@@ -700,7 +700,7 @@ v2v_unit_tests_LINK = \
 .depend: \
 	$(srcdir)/*.mli \
 	$(srcdir)/*.ml \
-	$(srcdir)/config.ml \
+	$(builddir)/config.ml \
 	$(srcdir)/output_rhv_upload_*_source.ml
 	$(top_builddir)/ocaml-dep.sh $^
 -include .depend
