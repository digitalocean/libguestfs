
=head1 НАЗВА

guestmount — монтування файлової системи гостьової операційної системи у
основній системі за допомогою FUSE і libguestfs

=head1 КОРОТКИЙ ОПИС

 guestmount [--параметри] -a диск.img -m пристрій [--ro] точка монтування

 guestmount [--параметри] -a диск.img -i [--ro] точка_монтування

 guestmount [--параметри] -d Гостьова_система -i [--ro] точка_монтування

=head1 ОПИС

Програмою guestmount можна скористатися для монтування файлових систем
віртуальної машини та інших образів дисків у основній системі. Програма
використовує libguestfs для доступу до гостьової файлової системи і FUSE
(«файлову систему у просторі користувача») так, що змонтована система
з'являється у основній системі як додатковий змонтований пристрій.

Разом із іншими параметрами вам слід надати принаймні один пристрій
(параметр I<-a>) або домен libvirt (параметр I<-d>) і принаймні одну точку
монтування (параметр I<-m>) або скористатися параметром інспектування I<-i>
чи параметром I<--live>. Кращий опис того, як це працює, наведено на
сторінці підручника щодо L<guestfish(1)>. Також можна скористатися
наведеними нижче прикладами.

FUSE надає вам змогу монтувати файлові системи від імені звичайного
користувача. Власником точки монтування має бути ваш користувач. Файлова
система лишатиметься невидимою для усіх інших користувачів, якщо ви не
внесете змін до налаштувань. Див. L</ПРИМІТКИ> нижче.

Для демонтування файлової системи скористайтеся програмою
L<guestunmount(1)>.

=head1 ПРИКЛАДИ

Для типової гостьової системи Windows, основна файлова система якої
розміщується на першому розділі:

 guestmount -a windows.img -m /dev/sda1 --ro /mnt

Для типової гостьової системи Linux із файловою системою /boot на першому
розділі і кореневою файловою системою на логічному томі:

 guestmount -a linux.img -m /dev/VG/LV -m /dev/sda1:/boot --ro /mnt

Щоб libguestfs виявила точки монтування гостьової системи:

 guestmount -a guest.img -i --ro /mnt

Для гостьової системи libvirt із назвою «Guest» можна віддати таку команду:

 guestmount -d Guest -i --ro /mnt

Якщо ви не знаєте, які файлові системи містяться у гостьовій операційній
системі або на образі диска, скористайтеся спочатку L<virt-filesystems(1)>:

 virt-filesystems -d MyGuest

Якщо вам потрібно трасувати виклики libguestfs, але без надмірних
діагностичних даних, рекомендуємо зробити так:

 guestmount [...] --trace /mnt

Якщо ви хочете виконати діагностику роботи програми, рекомендуємо таке:

 guestmount [...] --trace --verbose /mnt

Щоб демонтувати файлову систему після її використання:

 guestunmount /mnt

=head1 ПРИМІТКИ

=head2 Інші користувачі, типово, не можуть бачити файлову систему

Якщо ви змонтуєте файлову систему від імені одного користувача (наприклад,
root), інші користувачі типово не зможуть її бачити. Щоб виправити цей
недолік, додайте під час монтування параметр C<allow_other> FUSE:

 sudo guestmount [...] -o allow_other /mnt

B<та> для вмикання цього параметра у F</etc/fuse.conf>.

=head2 Вмикання FUSE

У деяких дистрибутивах користувача потрібно додати до спеціальної групи
(наприклад C<fuse>), перш ніж він зможе користуватися файловими системами
FUSE. Так, зокрема, влаштовано систему доступу у Debian та похідних від
нього дистрибутивах.

У інших дистрибутивах, зокрема Fedora та Red Hat Enterprise Linux, членство
у групі не є обов'язковим.

=head2 Помилка fusermount: «Device or resource busy»

Ви можете побачити це повідомлення про помилку, коли інший процес у системі
починає використовувати щойно створену вами точку монтування, утримуючи її
відкритою і заважаючи вам її демонтувати. Звичними «винуватцями» таких
проблем є різноманітні програми для індексування даних.

Популярним способом обійти цю проблему є повторні спроби виконати
C<fusermount -u> декілька разів, аж доки потрібну дію не буде виконано
(L<guestunmount(1)> робити це за вас). На жаль, цей спосіб не є
універсальним. Він не спрацює, якщо, наприклад, змонтована файлова система є
доволі великою Unfortunately this isn't a reliable fix if (for example)  the
mounted filesystem is particularly large and the intruding program
particularly persistent.

Належним вирішенням є використання приватної точки монтування шляхом
створення простору назв монтування за допомогою специфічного для Linux
прапорця L<clone(2)>/L<unshare(2)> C<CLONE_NEWNS>. На жаль, у поточній
версії це потребує прав доступу root. Крім того, нам, ймовірно, потрібно
буде додати цю можливість до guestmount.

=head2 Під час розірвання з'єднання можливий конфлікт через конкуренцію потоків
обробки

Коли L<guestunmount(1)>/L<fusermount(1)> завершує роботу, guestmount усе ще
може працювати над вилученням точки монтування. Образ диска у такому випадку
може вийти незавершеним.

Це означає, що скрипти, подібні до наведеного нижче, містять небезпечний
потенційний конфлікт потоків обробки через конкуренцію.

 guestmount -a disk.img -i /mnt
 # скопіювати дані до /mnt
 guestunmount /mnt
 # негайно спробувати використати 'disk.img' ** НЕБЕЗПЕЧНО **

Рішенням є використання параметра I<--pid-file> для запису PID guestmount до
файла, а потім, після guestunmount, очікування на завершення роботи цього
PID.

 guestmount -a disk.img -i --pid-file guestmount.pid /mnt
 
 # ...
 # ...
 
 # Зберегти PID guestmount *до* виклику guestunmount.
 pid="$(cat guestmount.pid)"
 
 # Демонтувати файлову систему.
 guestunmount /mnt
 
 timeout=10
 
 count=$timeout
 while kill -0 "$pid" 2>/dev/null && [ $count -gt 0 ]; do
     sleep 1
     ((count--))
 done
 if [ $count -eq 0 ]; then
     echo "$0: wait for guestmount to exit failed after $timeout seconds"
     exit 1
 fi
 
 # Тепер можна безпечно користуватися образом диска.

Зауважте, що якщо ви використовуєте програмний інтерфейс
C<guestfs_mount_local> безпосередньо (див. L<guestfs(3)/ЛОКАЛЬНЕ
МОНТУВАННЯ>), набагато простіше буде написати безпечну, позбавлену
конфліктів програму.

=head1 ПАРАМЕТРИ

=over 4

=item B<-a> ОБРАЗ

=item B<--add> ОБРАЗ

Додати блоковий пристрій або образ віртуальної машини.

Формат образу диска визначається автоматично. Щоб перевизначити його і
примусово використати певний формат, скористайтеся параметром
I<--format=..>.

=item B<-a> адреса

=item B<--add> адреса

Додати віддалений диск. Див. L<guestfish(1)/ДОДАВАННЯ ВІДДАЛЕНОГО СХОВИЩА>.

=item B<-c> адреса

=item B<--connect> адреса

Якщо використано у поєднанні із параметром I<-d>, визначає адресу libvirt,
якою слід скористатися. Типово, використовується типове з'єднання libvirt.

=item B<-d> ДОМЕН_LIBVIRT

=item B<--domain> ДОМЕН_LIBVIRT

Додати диски із названого домену libvirt. Якщо також використано параметр
I<--ro>, може бути використано будь-який домен libvirt. Втім, у режимі
запису тут можна вказати лише домени libvirt, які вимкнено.

Замість назв можна використовувати UUID доменів.

=item B<--dir-cache-timeout> N

Встановити час застарівання кешу readdir у значення I<N> секунд. Типовим
значенням є 60 секунд. Кеш readdir [насправді, існує декілька
напівнезалежних кешів] заповнюється після виклику readdir(2) статистикою і
розширеними атрибутами файлів у каталозі у сподіванні, що вони невдовзі
знову знадобляться.

Існує також інший кеш атрибутів, реалізований за допомогою FUSE
(див. параметр FUSE I<-o attr_timeout>), але кеш FUSE не розрахований на
наступні виклики — його призначено лише для кешування наявних.

=item B<--echo-keys>

Типово, якщо guestfish попросить вас ввести ключ або пароль, програма не
відтворюватиме введені символи на екрані. Якщо ви не боїтеся
TEMPEST-нападів, або у вашій кімнаті нікого, окрім вас, немає, ви можете
скористатися цим прапорцем, щоб бачити, які саме символи ви вводите.

=item B<--fd=>ДФ

Вказати канал або дескриптор файла eventfd. Коли точка монтування буде
готова до використання, guestmount запише один байт до цього дескриптора
файла. Цим можна скористатися, у поєднанні із I<--no-fork>, щоб запустити
guestmount у межах іншого процесу.

=item B<--format=raw|qcow2|..>

=item B<--format>

Типовим значенням для параметра I<-a> є автоматичне визначення формату
образу диска. Використання цього параметра примусово визначає значення
параметрів I<-a> формату диска у наступному рядку команди. Використання
параметра I<--format> без аргументу перемикає програму у режим автоматичного
визначення у наступних параметрах I<-a>.

Якщо ви користуєтеся ненадійними образами гостьових систем у необробленому
форматі, вам слід скористатися цим параметром для визначення формату
диска. Таким чином можна уникнути можливих проблем з захистом для
сформованих зловмисниками гостьових систем (CVE-2010-3851). Див. також
<guestfs(3)/guestfs_add_drive_opts>.

=item B<--fuse-help>

Вивести довідку щодо спеціальних параметрів FUSE (див. I<-o> нижче).

=item B<--help>

Показати короткі довідкові дані і завершити роботу.

=item B<-i>

=item B<--inspector>

Використовуючи код L<virt-inspector(1)>, виконати інспектування дисків,
шукаючи операційну систему і монтуючи файлові системи так, як їх мало б бути
змонтовано у справжній віртуальній машині.

=item B<--key> SELECTOR

Specify a key for LUKS, to automatically open a LUKS device when using the
inspection.  C<SELECTOR> can be in one of the following formats:

=over 4

=item B<--key> C<DEVICE>:key:KEY_STRING

Use the specified C<KEY_STRING> as passphrase.

=item B<--key> C<DEVICE>:file:FILENAME

Read the passphrase from F<FILENAME>.

=back

=item B<--keys-from-stdin>

Прочитати параметри ключа або пароля із джерела стандартного
введення. Типово програма намагається читати паролі від користувача
відкриттям F</dev/tty>.

=item B<--live>

З'єднатися із запущеною віртуальною машиною. (Експериментальна можливість,
див. L<guestfs(3)/ДОЛУЧЕННЯ ДО ЗАПУЩЕНИХ ФОНОВИХ СЛУЖБ>).

=item B<-m> пристрій[:точка_монтування[:параметри[:тип_файлової_системи]]]

=item B<--mount> пристрій[:точка_монтування[:параметри[:тип_файлової_системи]]]

Змонтувати вказаний за назвою розділ або логічний том до вказаної точки
монтування B<у гостьовій системі> (немає нічого спільного із точками
монтування у основній системі).

Якщо точку монтування не вказано, типовим значенням є F</>. Вам слід
змонтувати щось до F</>.

Третьою (і нечасто використовуваною) частиною параметра монтування є список
параметрів монтування, які використовуються для того, щоб змонтувати
підлеглу файлову систему. Якщо такий список не буде задано, параметрами
монтування вважатиметься або порожній рядок, або C<ro> (другий варіант
використовується, якщо використано прапорець I<--ro>). Заданням параметрів
монтування ви перевизначаєте типовий варіант. Ймовірно, єдиним випадком,
коли вам може знадобитися це, є випадок вмикання списків керування доступом
(ACL) і/або розширених атрибутів, якщо у файловій системі передбачено їхню
підтримку:

 -m /dev/sda1:/:acl,user_xattr

Четвертою частиною параметра є назва драйвера файлової системи, якою слід
скористатися, зокрема C<ext3> або C<ntfs>. У визначенні цієї частини
параметра рідко виникає потреба, але вона може бути корисною, якщо для
файлової системи можна скористатися декількома драйверами (приклад: C<ext2>
і C<ext3>), або libguestfs визначає файлову систему помилково.

=item B<--no-fork>

Не створювати фонової служби (або відгалуження у фоновий режим).

=item B<-n>

=item B<--no-sync>

Типово, під час демонтування точки монтування FUSE буде виконано спробу
синхронізувати диск гостьової операційної системи. Якщо ви вкажете цей
параметр, спроби синхронізуватися не виконуватиметься. Див. обговорення
автоматичної синхронізації на сторінці підручника L<guestfs(3)>.

=item B<-o> ПАРАМЕТР

=item B<--option> ПАРАМЕТР

Передати додаткові параметри FUSE.

Щоб отримати список усіх додаткових параметрів, підтримку яких передбачено у
FUSE, скористайтеся наведеною нижче командою. Зауважте, що можна передавати
лише параметри FUSE I<-o> і що лише деякі з них варто насправді передавати.

 guestmount --fuse-help

Деякі з потенційно корисних параметрів FUSE:

=over 4

=item B<-o> B<allow_other>

Дозволити іншим користувачам бачити файлову систему. Цей параметр не
працюватиме, якщо подібне спільне використання не передбачено на загальному
рівні у F</etc/fuse.conf>.

=item B<-o> B<attr_timeout=N>

Увімкнути кешування атрибутів у FUSE і встановити час застарівання у I<N>
секунд.

=item B<-o> B<kernel_cache>

Дозволити ядру кешувати файли (зменшує кількість читань, які мають пройти
через програмний інтерфейс L<guestfs(3)>). Зазвичай, корисно дозволяти певне
додаткове використання пам'яті.

=item B<-o> B<uid=N> B<-o> B<gid=N>

Скористайтеся цими параметрами для прив'язки усіх UID та GID у гостьовій
файловій системі до вибраних значень.

=item B<-o> B<use_ino>

Зберігати номери inode із базової файлової системи.

Якщо цей параметр не вказано, FUSE створюватиме власні номери inode. Номери
inode, які ви зазвичай бачите у L<stat(2)>, C<ls -i> тощо, не є номерами
inode у базовій файловій системі.

B<Зауваження>: використання цього параметра є потенційно небезпечним, якщо у
базова файлова система складається з декількох точок монтування, оскільки у
такому випадку можливе дублювання номерів inode через FUSE. Використання
цього параметра може призвести до неналежної роботи частини програм.

=back

=item B<--pid-file> НАЗВА_ФАЙЛА

Записати PID робочого процесу guestmount до файла C<назва_файла>.

=item B<-r>

=item B<--ro>

Додавати пристрої і монтування лише у режимі читання. Це заборонить запис, а
диск у FUSE буде показано як придатний лише до читання.

Наполегливо рекомендуємо скористатися цим параметром, якщо ви не маєте
намірів щодо редагування диска гостьової системи. Якщо гостьова система
працює, а цей параметр I<не> вказано, існує дуже висока ймовірність
пошкодити дані на диску. Ми намагаємося запобігати такому пошкодженню, але
це не завжди можливо.

Див. також L<guestfish(1)/OPENING DISKS FOR READ AND WRITE>.

=item B<--selinux>

Цей параметр призначено для забезпечення зворотної сумісності, його
використання не матиме жодних наслідків.

=item B<-v>

=item B<--verbose>

Уможливити докладні повідомлення від підлеглої частини libguestfs.

=item B<-V>

=item B<--version>

Показати дані щодо версії програми, потім вийти

=item B<-w>

=item B<--rw>

Змінює дію параметрів I<-a>, I<-d> і I<-m> таким чином, що диски додаються і
монтуються у режимі читання і запису.

Див. L<guestfish(1)/OPENING DISKS FOR READ AND WRITE>.

=item B<-x>

=item B<--trace>

Трасувати виклики libguestfs і заходити до кожної функції FUSE.

Це також забороняє фоновій службі створювати відгалуження у фоновому режимі
(див. I<--no-fork>).

=back

=head1 ФАЙЛИ

=over 4

=item $XDG_CONFIG_HOME/libguestfs/libguestfs-tools.conf

=item $HOME/.libguestfs-tools.rc

=item $XDG_CONFIG_DIRS/libguestfs/libguestfs-tools.conf

=item /etc/libguestfs-tools.conf

Цей файл налаштувань керує типовим режимом — лише читання чи читання і запис
(I<--ro> або I<--rw>).

Див. L<libguestfs-tools.conf(5)>.

=back

=head1 СТАН ВИХОДУ

Ця програма повертає значення 0 у разі успішного завершення і ненульове
значення, якщо сталася помилка.

=head1 ТАКОЖ ПЕРЕГЛЯНЬТЕ

L<guestunmount(1)>, L<fusermount(1)>, L<guestfish(1)>, L<virt-inspector(1)>,
L<virt-cat(1)>, L<virt-edit(1)>, L<virt-tar(1)>,
L<libguestfs-tools.conf(5)>, L<guestfs(3)/ЛОКАЛЬНЕ МОНТУВАННЯ>,
L<http://libguestfs.org/>, L<http://fuse.sf.net/>.

=head1 АВТОРИ

Richard W.M. Jones (C<rjones at redhat dot com>)

=head1 АВТОРСЬКІ ПРАВА

Copyright (C) 2009-2019 Red Hat Inc.

