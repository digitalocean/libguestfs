
=head1 НАЗВА

virt-sysprep — скидання налаштувань віртуальної машини до початкових, так,
щоб з неї можна було роботи клони

=head1 КОРОТКИЙ ОПИС

 virt-sysprep [--параметри] -d назва_домену

 virt-sysprep [--параметри] -a disk.img [-a disk.img ...]

=head1 ОПИС

Virt-sysprep може відновити початковий стан або зняти налаштовування з
віртуальної машини, щоб з неї можна було робити клони. Кроками цієї
процедури є вилучення ключів вузла SSH, вилучення сталих налаштувань мережі
щодо MAC та вилучення облікових записів користувачів. Крім того,
virt-sysprep може налаштовувати віртуальну машину, наприклад, додаванням
ключів SSH, користувачів чи логотипів. Ви можете вмикати або вимикати кожен
з цих кроків.

Virt-sysprep вносить зміни до гостьової системи або образу диска I<на
місці>. Гостьова система має бути вимкненою. Якщо ви хочете зберегти наявний
вміст гостьової системи, I<вам слід спочатку зробити її знімок, скопіювати
або клонувати її диск>. Див. L</КОПІЮВАННЯ І КЛОНУВАННЯ> нижче.

Вам I<не потрібно> запускати virt-sysprep від імені користувача
root. Фактично, запуск у такому режимі є нерекомендованим. Єдиною причиною
запускати програму від імені root може бути потреба у доступі до образу
диска, але навіть у цьому випадку, доцільніше змінити права доступу до
образу диска так, щоб запис до нього став доступним від імені користувача,
який запускає virt-sysprep.

«Sysprep» — скорочення від «system preparation» («приготування
системи»). Назва походить від програми Microsoft F<sysprep.exe>, яка
використовується для вилучення налаштувань з Windows у приготуваннях до
клонування системи. Маємо зауважити, що у поточній версії virt-sysprep I<не>
може працювати із гостьовими системами Microsoft Windows. Ми плануємо
впровадити підтримку приготування Windows у майбутніх версіях і вже маємо
певні напрацювання щодо цього.

=head1 ПАРАМЕТРИ

=over 4

=item B<--help>

Показати коротку довідку.

=item B<-a> файл

=item B<--add> файл

Додати I<файл>, який має бути образом диска з віртуальної машини.

Формат образу диска визначається автоматично. Щоб перевизначити його і
примусово використати певний формат, скористайтеся параметром I<--format>.

=item B<-a> адреса

=item B<--add> адреса

Додати віддалений диск. Формат адреси є сумісним із
guestfish. Див. L<guestfish(1)/ДОДАВАННЯ ВІДДАЛЕНОГО СХОВИЩА>.

=item B<--colors>

=item B<--colours>

Використовувати послідовності символів ANSI для розфарбовування
повідомлень. Ці послідовності типово використовуються, якщо дані виводяться
на термінал tty.  Якщо дані, виведені програмою, спрямовуються до файла,
послідовності визначення кольорів ANSI буде вимкнено, якщо ви не додасте до
команди цей параметр.

=item B<-c> адреса

=item B<--connect> адреса

Якщо використовується libvirt, встановити з’єднання з вказаним I<URI>. Якщо
пропущено, з’єднання буде встановлено з типовим гіпервізором libvirt.

Якщо вказати блокові пристрої гостьових систем безпосередньо (I<-a>),
libvirt не буде використовуватися взагалі.

=item B<-d> гість

=item B<--domain> гість

Додати всі диски з вказаної гостьової системи libvirt. UUID доменів можна
використовувати замість назв.

=item B<-n>

=item B<--dry-run>

Виконати тестову обробку гостьової системи у режимі «лише читання». Буде
виконано дію sysprep, але наприкінці усі зміни до диска буде відкинуто.

=item B<--enable> дії

Визначає дії з приготування, які слід виконати. Ви можете вказати список
дій, відокремлених комами, ось так:

 --enable ssh-hostkeys,udev-persistent-net

Тут увімкнено лише дії C<ssh-hostkeys> і C<udev-persistent-net>.

Якщо параметр I<--enable> не вказано, типово буде виконано якомога більше
дій з приготування системи (див. I<--list-operations>, щоб переглянути
список увімкнених дій).

Незалежно від вказаного параметра I<--enable>, для певних типів гостьових
систем деякі дії пропускаються.

Скористайтеся параметром I<--list-operations>, щоб переглянути список дій,
підтримку яких передбачено у вашій версії virt-sysprep.

Список дій із поясненнями щодо них наведено у розділі L</ДІЇ> нижче.

=item B<--operation> дії

=item B<--operations> дії

Визначає дії з приготування, які слід виконати. Ви можете вказати список
дій, відокремлених комами, ось так:

 --operations ssh-hostkeys,udev-persistent-net

Тут увімкнено лише дії C<ssh-hostkeys> і C<udev-persistent-net>.

За допомогою параметра I<--operations> ви зможете увімкнути або вимкнути
будь-які дї, зокрема типові (ті, які виконуватимуться, якщо не вказано ні
I<--operations>, ні I<--enable>) та усі доступні; додавання C<-> перед
назвою дії вилучає її зі списку увімкнених дій, а метаназви C<defaults> і
C<all> відповідають діям, які типово увімкнено і усім доступним
діям. Приклад:

 --operations firewall-rules,defaults,-tmp-files

Ця команда вмикає дію C<firewall-rules> (незалежно від того, чи було її
типово увімкнено), усі типові дії і вимикає дію C<tmp-files>.

Параметр I<--operations> може бути вказано декілька разів; під час першого
використання набір увімкнених дій вважається порожнім, усі наступні
використання I<--operations> стосуватимуться уже увімкненого набору дій.

Якщо параметр I<--operations> не вказано, типово буде виконано якомога
більше дій з приготування системи (див. I<--list-operations>, щоб
переглянути список увімкнених дій).

Незалежно від вказаного параметра I<--operations>, для певних типів
гостьових систем деякі дії пропускаються.

Скористайтеся параметром I<--list-operations>, щоб переглянути список дій,
підтримку яких передбачено у вашій версії virt-sysprep.

Список дій із поясненнями щодо них наведено у розділі L</ДІЇ> нижче.

=item B<--echo-keys>

Типово, якщо virt-sysprep попросить вас ввести ключ або пароль, програма не
відтворюватиме введені символи на екрані. Якщо ви не боїтеся
TEMPEST-нападів, або у вашій кімнаті нікого, окрім вас, немає, ви можете
скористатися цим прапорцем, щоб бачити, які саме символи ви вводите.

=item B<--format> raw|qcow2|..

=item B<--format> auto

Типовим значенням для параметра I<-a> є автоматичне визначення формату
образу диска. Використання цього параметра примусово визначає значення
параметрів I<-a> формату диска у наступному рядку команди. Використання
параметра I<--format auto> перемикає програму у режим автоматичного
визначення у наступних параметрах I<-a>.

Приклад:

 virt-sysprep --format raw -a disk.img

примусове встановлення формату без обробки (без автоматичного визначення)
для F<disk.img>.

 virt-sysprep --format raw -a disk.img --format auto -a another.img

примусове встановлення формату без обробки (без автоматичного визначення)
для F<diskimg> і повернення до автоматичного визначення для F<another.img>.

Якщо ви користуєтеся ненадійними образами гостьових систем у необробленому
форматі, вам слід скористатися цим параметром для визначення формату
диска. Таким чином можна уникнути можливих проблем з захистом для
сформованих зловмисниками гостьових систем (CVE-2010-3851).

=item B<--key> SELECTOR

Specify a key for LUKS, to automatically open a LUKS device when using the
inspection.  C<SELECTOR> can be in one of the following formats:

=over 4

=item B<--key> C<DEVICE>:key:KEY_STRING

Use the specified C<KEY_STRING> as passphrase.

=item B<--key> C<DEVICE>:file:FILENAME

Read the passphrase from F<FILENAME>.

=back

=item B<--keys-from-stdin>

Прочитати параметри ключа або пароля із джерела стандартного
введення. Типово програма намагається читати паролі від користувача
відкриттям F</dev/tty>.

=item B<--list-operations>

Список дій, підтримку яких передбачено у програмі virt-sysprep.

Дії буде показано по одній на рядок із одним або декількома полями,
відокремленими комами. Приклад:

 $ virt-sysprep --list-operations
 bash-history * Вилучити журнал команд bash у гостьовій системі
 cron-spool * Вилучити завдання at та cron користувачів
 dhcp-client-state * Вилучити надані клієнтські адреси DHCP
 dhcp-server-state * Вилучити надані серверні адреси DHCP
 [тощо]

У першому полі міститься назва дії, яку можна додати до параметра
I<--enable>. У другому полі міститься символ C<*>, якщо дію типово
увімкнено, і пробіл, якщо дію вимкнено. Наступні поля у тому самому рядку є
описом дії.

До libguestfs 1.17.33 показувалося лише перше поле (назва дії) і усі дії
було типово увімкнено.

=item B<--mount-options>
точка_монтування:параметри[;точка_монтування:параметри;...]

Встановлює параметри монтування, які використовуються, коли libguestfs
відкриває образ диска. Зауважте, що це не впливає на гостьову систему. Ці
дані використовуються при відкритті певних гостьових систем, зокрема тих, де
використовується файлова система UFS (BSD).

Слід використовувати список відокремлених крапкою з комою пар
C<точка_монтування:параметри>. Ймовірно, список слід взяти у лапки, щоб
захистити його від обробки командною оболонкою.

Приклад:

 --mount-options "/:noatime"

змонтує кореневий каталог із параметром C<notime>. А ось цей приклад:

 --mount-options "/:noatime;/var:rw,nodiratime"

зробить те саме, але ще і змонтує F</var> з параметрами C<rw,nodiratime>.

=item B<-q>

=item B<--quiet>

Не виводити повідомлення до журналу.

Для вмикання ведення докладного журналу окремих дій з файлами скористайтеся
I<-x>.

=item B<--network>

=item B<--no-network>

Увімкнути чи вимкнути доступ до мережі для гостьової системи під час
встановлення.

У virt-sysprep роботу у мережі типово I<вимкнено>. Вам слід скористатися
параметром I<--network>, щоб увімкнути її та мати змогу скористатися
параметрами, подібними до I<--install> або I<--update>.

На сторінці підручника L<virt-builder(1)> можна знайти додаткові дані щодо
переваг у захисті від вимикання мережі.

=item B<-v>

=item B<--verbose>

Увімкнути докладний показ повідомлень з метою діагностики.

=item B<-V>

=item B<--version>

Показати дані щодо версії і завершити роботу.

=item B<-x>

Увімкнути трасування викликів програмного інтерфейсу libguestfs.

__EXTRA_OPTIONS__

=back

=head1 ДІЇ

Якщо параметр I<--enable>/I<--operations> I<не> вказано, більшу частину дій
з приготування системи буде увімкнено.

Скористайтеся командою C<virt-sysprep --list-operations>, щоб переглянути
список усіх дій, які передбачено у вашому виконуваному файлі
virt-sysprep. Дії, які типово увімкнено, буде позначено у списку символом
C<*>. Незалежно від вказаних параметрів I<--enable>/I<--operations> для
певних типів гостьових систем деякі з дій з приготування системи
пропускатимуться.

Окремі дії можна увімкнути за допомогою параметрів
I<--enable>/I<--operations>. Записи дій у списку слід відокремлювати
комами. Приклад:

 virt-sysprep --operations ssh-hostkeys,udev-persistent-net [тощо..]

У майбутніх версіях virt-sysprep може бути додано інші дії. Якщо ви
використовуєте virt-sysprep, і вам потрібна передбачувана поведінка,
вказуйте лише ті дії, які ви хочете увімкнути.

C<*> = типово увімкнено, якщо не вказано параметрів
I<--enable>/I<--operations>.

__OPERATIONS__

=head1 КОПІЮВАННЯ ТА КЛОНУВАННЯ

Virt-sysprep можна скористатися як частиною процедури клонування гостьових
систем або приготування шаблона, з якого можна буде клонувати гостьові
системи. Існує багато різних способів досягти цього за допомогою засобів
віртуалізації, — цей розділ є лише вступом.

Віртуальна машина (коли її вимкнено) складається з двох частин:

=over 4

=item I<налаштування>

Налаштування або опис гостьової системи. Приклади: XML libvirt (див. C<virsh
dumpxml>), поточні налаштування гостьової системи або інший зовнішній
формат, наприклад OVF.

Деякі пункти налаштувань, які варто було б змінити:

=over 4

=item *

назва

=item *

UUID

=item *

шлях до блокових пристроїв

=item *

MAC-адреса мережевої картки

=back

=item I<блокові пристрої>

Один або декілька образів дисків, які самі містять файли, каталоги,
програми, ядра, налаштування тощо.

Ось деякі параметри всередині блокових пристроїв, які, можливо, доведеться
змінити:

=over 4

=item *

назва вузла та інші налаштування мережі

=item *

UUID

=item *

ключі SSH вузла

=item *

Унікальний ідентифікатор безпеки Windows (SID)

=item *

Реєстрація маріонетки

=back

=back

=head2 КОПІЮВАННЯ БЛОКОВОГО ПРИСТРОЮ

Маючи початкову гостьову систему, ви, ймовірно, хочете скопіювати блоковий
пристрій гостьової системи і його налаштування, щоб створити шаблон. Далі,
коли вас задовольнятимуть характеристики шаблона, ви захочете створити на
його основі клони.

                        virt-sysprep
                             |
                             v
 початкова система --------> шаблон ---------->
                                      \------> клоновані
                                       \-----> гостьові системи
                                        \---->

Ви, звичайно ж, можете просто скопіювати блоковий пристрій на основну
систему за допомогою L<cp(1)> або L<dd(1)>.

                   dd                 dd
 початкова система --------> шаблон ---------->
                                      \------> клоновані
                                       \-----> гостьові системи
                                        \---->

Існують і кращі (і швидші) способи досягти результату:

                          знімок-
                шаблон ---------->
                            \------> клоновані
                             \-----> гостьові системи
                              \---->

Ймовірно, virt-sysprep доведеться запустити двічі — один раз для відновлення
початкового стану гостьової системи (для створення шаблона) і другий раз для
налаштовування гостьової системи для певного користувача:

                    virt-sysprep        virt-sysprep
                      (скидання)      (додавання користувача, ключів, логотипів)
                         |                   |
                 dd      v          dd       v
 початкова система ----> шаблон ---------> копійований ------> нетипова
                                          шаблон       гостьова система

=over 4

=item *

Створити знімок за допомогою qemu-img:

 qemu-img create -f qcow2 -o backing_file=original snapshot.qcow

Перевагою є те, що вам не потрібно буде копіювати оригінал (дуже швидко), і
те, що зберігатимуться лише зміни (менше вживання місця у сховищі даних).

Зауважте, що запис резервного файла після створення на його основі гостьових
систем неможливий: такий запис призведе до пошкодження гостьових систем.

=item *

Створити знімок за допомогою C<lvcreate --snapshot>.

=item *

До інших способів створення знімків належить використання засобів файлової
системи (для файлових систем, які подібні до btrfs).

На більшості пристроїв Network Attached Storage (NAS) передбачено можливість
простого створення знімків на основі файлів та LUN.

=item *

Накажіть вашому NAS здублювати LUN. На більшості пристроїв NAS також
передбачено дуже просте дублювання LUN (копіювання відбувається у фоновому
режимі за запитом).

=item *

Приготуйте ваш шаблон за допомогою L<virt-sparsify(1)>. Див. нижче.

=back

=head2 VIRT-CLONE

Для дублювання блокового пристрою і/або внесення змін до зовнішніх
налаштувань libvirt гостьової системи можна скористатися окремим
інструментом, L<virt-clone(1)>. Ця програма відновить початкові значення
назви, UUID та адреси MAC гостьової системи в XML libvirt.

L<virt-clone(1)> не використовує libguestfs і не може «зазирнути» у образ
диска. Це і було причиною для написання virt-sysprep.

=head2 РОЗРІДЖЕННЯ

              virt-sparsify
 початкова система --------> шаблон

L<virt-sparsify(1)> можна скористатися для зменшення розмірів шаблона для
клонування, спрощуючи стискання і/або пришвидшуючи копіювання.

Зауважте, що оскільки virt-sparsify також копіює образ, ви можете
скористатися цією програмою для створення початкової копії (замість C<dd>).

=head2 ЗМІНА РОЗМІРІВ

                         virt-resize
                  шаблон ---------->
                            \------> клоновані
                             \-----> гостьові системи
                              \---->

Якщо ви хочете надати комусь клоновані гостьові системи, але хочете надати
можливість вибирати розмір гостьової системи (наприклад за місцем, яке
надається гостьовій системі на диску), замість копіювання шаблона вам слід
запустити L<virt-resize(1)>. Virt-resize виконує копіювання і зміну
розмірів, тому програма є ідеальною для клонування гостьових систем з
шаблона.

=head1 FIRSTBOOT ЧИ SCRIPT

Обидва параметри, I<--firstboot> і I<--script>, запускають скрипти оболонки,
яка виконують дії із гостьовою системою. Втім, ці параметри суттєво
різняться.

I<--firstboot скрипт> вивантажує файл C<скрипт> до гостьової системи і
робить так, щоб він запускався у гостьовій системі під час наступного її
завантаження. (Скрипт буде запущено лише один раз, при «першому
завантаження».)

I<--script скрипт> запускає скрипт командної оболонки C<скрипт> I<у основній
системі>, у поточному каталозі у файловій системі гостьової операційної
системи.

Якщо вам, наприклад, потрібно виконати C<yum install> для встановлення нових
пакунків, вам I<не слід> використовувати для цього I<--script>, оскільки це
(а) запустить програму C<yum> у основній системі і (б) не надасть програмі
доступ до тих самих ресурсів (сховищ, ключів тощо), доступ до яких має
гостьова система. Усі команди, які мають працювати у гостьовій системі
I<слід> запускати за допомогою I<--firstboot>.

З іншого боку, якщо вам потрібно щось скоригувати у файловій системі
гостьової операційної системи (наприклад, копіюванням даних до файлів), тоді
ідеально буде використатися I<--script>, оскільки (a) так скрипт матиме
доступ до файлової системи основної операційної системи і (b) ви одразу
отримаєте повідомлення про помилки.

Кожен з параметрів або обидва параметри можна використовувати у рядку
команди довільну кількість разів.

=head1 БЕЗПЕКА

Хоча virt-sysprep вилучає певні конфіденційні дані з гостьової системи,
програма не претендує на вилучення усіх цих даних. Вам слід ознайомитися із
розділом L</ДІЇ> вище і вивчити саму гостьову систему після виконання дій.

Файли з конфіденційними даними просто вилучаються. Дані, які у них
містяться, можуть залишатися на диску. Такі дані доволі просто відновити за
допомогою шістнадцяткового редактора або засобів для відновлення файлів. Ви
можете скористатися параметром I<--scrub> для витирання вмісту файлів
замість простого їх вилучення. Ще одним способом вилучити конфіденційні дані
є використання L<virt-sparsify(1)>. Крім того, витерти вміст вилучених
каталогів та inode можна за допомогою команди L<scrub(1)>.

=head2 БАЗА ВИПАДКОВОСТІ

I<(Цей розділ стосується лише гостьових систем Linux)>

У підтримуваних гостьових системах virt-sysprep записує декілька випадкових
байтів з основної системи до файла породжувача псевдовипадкової
послідовності гостьової системи.

Якщо ця процедура виконується один раз, а гостьова система клонується з того
самого шаблона, кожна гостьова система починатиме з того самого значення
ентропії, отже дані, подібні до ключів SSH вузла і послідовностей чисел TCP,
можуть бути передбачуваними.

Тому вам слід забезпечити додавання певного рівня випадковості I<після>
клонування з шаблона. Зробити це можна за допомогою простого вмикання модуля
customize:

 cp шаблон.img нова_гостьова_система.img
 virt-sysprep --enable customize -a нова_гостьова_система.img

=head1 SELINUX

Для гостьових систем, у яких використовується SELinux, може знадобитися
спеціальна обробка, якщо використовуються дії, які створюють нові файли або
вносять зміни до наявних файлів.

Докладніший опис наведено у розділі L<virt-builder(1)/SELINUX>.

=head1 WINDOWS 8

«Швидкий запуск» Windows 8 може заважати роботі
virt-sysprep. Див. L<guestfs(3)/ПРИСИПЛЯННЯ WINDOWS  ТА ШВИДКИЙ ЗАПУСК
WINDOWS 8>.

=head1 СТАН ВИХОДУ

Ця програма повертає 0, якщо роботу виконано успішно, і 1, якщо сталися
помилки.

=head1 ЗМІННІ СЕРЕДОВИЩА

=over 4

=item C<VIRT_TOOLS_DATA_DIR>

Ця змінна визначає каталог, у якому містяться файли даних, які
використовуються для встановлення Windows з першим завантаженням.

Зазвичай, потреби у встановленні власного значення немає. Якщо значення не
встановлено, буде використано вбудоване типове значення (щось схоже на
F</usr/share/virt-tools>).

Цей каталог може містити такі файли:

=over 4

=item F<rhsrvany.exe>

Це виконуваний файл для Windows RHSrvAny, який використовується для
встановлення скрипту «firstboot» у гостьові системи Windows. Він
знадобиться, якщо ви маєте намір використовувати параметри I<--firstboot> і
I<--firstboot-command> для гостьових операційних систем Windows.

Див. також C<https://github.com/rwmjones/rhsrvany>

=item F<pvvxsvc.exe>

Це виконуваний файл Windows, що постачається разом із VMDP SUSE,
використовується для встановлення скрипту «firstboot» у гостьові системи
Windows. Він знадобиться, якщо ви маєте намір використовувати параметри
I<--firstboot> і I<--firstboot-command> для гостьових операційних систем
Windows.

=back

=back

Опис інших змінних середовища наведено у розділі L<guestfs(3)/ENVIRONMENT
VARIABLES>.

=head1 ТАКОЖ ПЕРЕГЛЯНЬТЕ

L<guestfs(3)>, L<guestfish(1)>, L<virt-builder(1)>, L<virt-clone(1)>,
L<virt-customize(1)>, L<virt-rescue(1)>, L<virt-resize(1)>,
L<virt-sparsify(1)>, L<virsh(1)>, L<lvcreate(8)>, L<qemu-img(1)>,
L<scrub(1)>, L<http://libguestfs.org/>, L<http://libvirt.org/>.

=head1 АВТОРИ

Richard W.M. Jones L<http://people.redhat.com/~rjones/>

Wanlong Gao, Fujitsu Ltd.

=head1 АВТОРСЬКІ ПРАВА

Copyright (C) 2011-2019 Red Hat Inc.

Авторські права належать Fujitsu Ltd., 2012

